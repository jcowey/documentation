<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">

<title>Class: HgvMetaIdentifiersController</title>

<link type="text/css" media="screen" href="./rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script type="text/javascript" charset="utf-8" src="./js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/darkfish.js"></script>


<body id="top" class="class">
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="./index.html">Home</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  <div id="file-metadata">
    <nav id="file-list-section" class="section">
  <h3 class="section-header">Defined In</h3>
  <ul>
    <li>app/controllers/hgv_meta_identifiers_controller.rb
  </ul>
</nav>

    
  </div>

  <div id="class-metadata">
    
    <nav id="parent-class-section" class="section">
  <h3 class="section-header">Parent</h3>
  
  <p class="link"><a href="IdentifiersController.html">IdentifiersController</a>
  
</nav>

    
    <!-- Method Quickref -->
<nav id="method-list-section" class="section">
  <h3 class="section-header">Methods</h3>

  <ul class="link-list">
    
    <li><a href="#method-i-complement_params">#complement_params</a>
    
    <li><a href="#method-i-edit">#edit</a>
    
    <li><a href="#method-i-find_identifier">#find_identifier</a>
    
    <li><a href="#method-i-generate_flash_message">#generate_flash_message</a>
    
    <li><a href="#method-i-get_date_preview">#get_date_preview</a>
    
    <li><a href="#method-i-get_geo_preview">#get_geo_preview</a>
    
    <li><a href="#method-i-preview">#preview</a>
    
    <li><a href="#method-i-prune_params">#prune_params</a>
    
    <li><a href="#method-i-save_comment">#save_comment</a>
    
    <li><a href="#method-i-update">#update</a>
    
  </ul>
</nav>

  </div>

  <div id="project-metadata">
    <nav id="fileindex-section" class="section project-section">
  <h3 class="section-header">Pages</h3>

  <ul>
  
    <li class="file"><a href="./doc/README_FOR_APP.html">README_FOR_APP</a>
  
  </ul>
</nav>

    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="./HgvMetaIdentifierHelper.html">HgvMetaIdentifierHelper</a>
  
    <li><a href="./HgvMetaIdentifierHelper/HgvDate.html">HgvMetaIdentifierHelper::HgvDate</a>
  
    <li><a href="./HgvMetaIdentifierHelper/HgvFormat.html">HgvMetaIdentifierHelper::HgvFormat</a>
  
    <li><a href="./HgvMetaIdentifierHelper/HgvFuzzy.html">HgvMetaIdentifierHelper::HgvFuzzy</a>
  
    <li><a href="./HgvMetaIdentifierHelper/HgvGeo.html">HgvMetaIdentifierHelper::HgvGeo</a>
  
    <li><a href="./HgvMetaIdentifierHelper/HgvGeo/GeoSpot.html">HgvMetaIdentifierHelper::HgvGeo::GeoSpot</a>
  
    <li><a href="./HgvMetaIdentifierHelper/HgvGeo/Place.html">HgvMetaIdentifierHelper::HgvGeo::Place</a>
  
    <li><a href="./HgvMetaIdentifierHelper/HgvGeo/Provenance.html">HgvMetaIdentifierHelper::HgvGeo::Provenance</a>
  
    <li><a href="./HgvMetaIdentifierHelper/HgvMentionedDate.html">HgvMetaIdentifierHelper::HgvMentionedDate</a>
  
    <li><a href="./HgvMetaIdentifierHelper/HgvProvenance.html">HgvMetaIdentifierHelper::HgvProvenance</a>
  
    <li><a href="./HgvMetaIdentifierHelper/HgvPublication.html">HgvMetaIdentifierHelper::HgvPublication</a>
  
    <li><a href="./BiblioIdentifier.html">BiblioIdentifier</a>
  
    <li><a href="./BiblioIdentifier/Container.html">BiblioIdentifier::Container</a>
  
    <li><a href="./BiblioIdentifier/Note.html">BiblioIdentifier::Note</a>
  
    <li><a href="./BiblioIdentifier/PublicationPerson.html">BiblioIdentifier::PublicationPerson</a>
  
    <li><a href="./BiblioIdentifier/Publisher.html">BiblioIdentifier::Publisher</a>
  
    <li><a href="./BiblioIdentifier/RelatedArticle.html">BiblioIdentifier::RelatedArticle</a>
  
    <li><a href="./BiblioIdentifier/RelatedItem.html">BiblioIdentifier::RelatedItem</a>
  
    <li><a href="./BiblioIdentifier/Reviewee.html">BiblioIdentifier::Reviewee</a>
  
    <li><a href="./BiblioIdentifier/ShortTitle.html">BiblioIdentifier::ShortTitle</a>
  
    <li><a href="./JRubyXML.html">JRubyXML</a>
  
    <li><a href="./JRubyXML/EpiDocP4Validator.html">JRubyXML::EpiDocP4Validator</a>
  
    <li><a href="./JRubyXML/EpiDocP5Validator.html">JRubyXML::EpiDocP5Validator</a>
  
    <li><a href="./JRubyXML/JARVValidator.html">JRubyXML::JARVValidator</a>
  
    <li><a href="./JRubyXML/NamespaceContext.html">JRubyXML::NamespaceContext</a>
  
    <li><a href="./JRubyXML/ParseError.html">JRubyXML::ParseError</a>
  
    <li><a href="./JRubyXML/ParseErrorHandler.html">JRubyXML::ParseErrorHandler</a>
  
    <li><a href="./JRubyXML/RDFValidator.html">JRubyXML::RDFValidator</a>
  
    <li><a href="./JRubyXML/TransformErrorListener.html">JRubyXML::TransformErrorListener</a>
  
    <li><a href="./REXML.html">REXML</a>
  
    <li><a href="./REXML/Document.html">REXML::Document</a>
  
    <li><a href="./REXML/Element.html">REXML::Element</a>
  
    <li><a href="./REXML/XPath.html">REXML::XPath</a>
  
    <li><a href="./NumbersRDF.html">NumbersRDF</a>
  
    <li><a href="./NumbersRDF/NumbersHelper.html">NumbersRDF::NumbersHelper</a>
  
    <li><a href="./NumbersRDF/Timeout.html">NumbersRDF::Timeout</a>
  
    <li><a href="./Rpx.html">Rpx</a>
  
    <li><a href="./Rpx/RpxException.html">Rpx::RpxException</a>
  
    <li><a href="./Rpx/RpxHelper.html">Rpx::RpxHelper</a>
  
    <li><a href="./Comment.html">Comment</a>
  
    <li><a href="./Comment/CombineComment.html">Comment::CombineComment</a>
  
    <li><a href="./Doco.html">Doco</a>
  
    <li><a href="./Doco/DocoNode.html">Doco::DocoNode</a>
  
    <li><a href="./Grit.html">Grit</a>
  
    <li><a href="./Grit/Commit.html">Grit::Commit</a>
  
    <li><a href="./HGVMetaIdentifier.html">HGVMetaIdentifier</a>
  
    <li><a href="./HGVMetaIdentifier/HgvMetaConfiguration.html">HGVMetaIdentifier::HgvMetaConfiguration</a>
  
    <li><a href="./HGVTransGlossary.html">HGVTransGlossary</a>
  
    <li><a href="./HGVTransGlossary/Entry.html">HGVTransGlossary::Entry</a>
  
    <li><a href="./APISIdentifier.html">APISIdentifier</a>
  
    <li><a href="./AjaxProxyController.html">AjaxProxyController</a>
  
    <li><a href="./ApplicationController.html">ApplicationController</a>
  
    <li><a href="./ApplicationHelper.html">ApplicationHelper</a>
  
    <li><a href="./BiblioFormBuilder.html">BiblioFormBuilder</a>
  
    <li><a href="./BiblioIdentifiersController.html">BiblioIdentifiersController</a>
  
    <li><a href="./Board.html">Board</a>
  
    <li><a href="./BoardsController.html">BoardsController</a>
  
    <li><a href="./CollectionIdentifier.html">CollectionIdentifier</a>
  
    <li><a href="./CollectionIdentifiersController.html">CollectionIdentifiersController</a>
  
    <li><a href="./CommentsController.html">CommentsController</a>
  
    <li><a href="./CommunitiesController.html">CommunitiesController</a>
  
    <li><a href="./Community.html">Community</a>
  
    <li><a href="./CrossSiteController.html">CrossSiteController</a>
  
    <li><a href="./DDBIdentifier.html">DDBIdentifier</a>
  
    <li><a href="./DdbIdentifiersController.html">DdbIdentifiersController</a>
  
    <li><a href="./Decree.html">Decree</a>
  
    <li><a href="./DecreesController.html">DecreesController</a>
  
    <li><a href="./DocosController.html">DocosController</a>
  
    <li><a href="./DocovideosController.html">DocovideosController</a>
  
    <li><a href="./Emailer.html">Emailer</a>
  
    <li><a href="./EmailerMailer.html">EmailerMailer</a>
  
    <li><a href="./EmailersController.html">EmailersController</a>
  
    <li><a href="./Event.html">Event</a>
  
    <li><a href="./EventsController.html">EventsController</a>
  
    <li><a href="./GitConf.html">GitConf</a>
  
    <li><a href="./HGVIdentifier.html">HGVIdentifier</a>
  
    <li><a href="./HGVTransIdentifier.html">HGVTransIdentifier</a>
  
    <li><a href="./HelperController.html">HelperController</a>
  
    <li><a href="./HgvMetaIdentifiersController.html">HgvMetaIdentifiersController</a>
  
    <li><a href="./HgvTransGlossariesController.html">HgvTransGlossariesController</a>
  
    <li><a href="./HgvTransIdentifiersController.html">HgvTransIdentifiersController</a>
  
    <li><a href="./Identifier.html">Identifier</a>
  
    <li><a href="./IdentifiersController.html">IdentifiersController</a>
  
    <li><a href="./Integer.html">Integer</a>
  
    <li><a href="./Leiden.html">Leiden</a>
  
    <li><a href="./LeidenController.html">LeidenController</a>
  
    <li><a href="./LinkingInfo.html">LinkingInfo</a>
  
    <li><a href="./MaintenanceMode.html">MaintenanceMode</a>
  
    <li><a href="./Object.html">Object</a>
  
    <li><a href="./PrettySsime.html">PrettySsime</a>
  
    <li><a href="./Publication.html">Publication</a>
  
    <li><a href="./PublicationsController.html">PublicationsController</a>
  
    <li><a href="./Rails.html">Rails</a>
  
    <li><a href="./RepositoriesController.html">RepositoriesController</a>
  
    <li><a href="./Repository.html">Repository</a>
  
    <li><a href="./RpxController.html">RpxController</a>
  
    <li><a href="./TranslationHelperController.html">TranslationHelperController</a>
  
    <li><a href="./TranslationLeiden.html">TranslationLeiden</a>
  
    <li><a href="./TranslationLeidenController.html">TranslationLeidenController</a>
  
    <li><a href="./User.html">User</a>
  
    <li><a href="./UserController.html">UserController</a>
  
    <li><a href="./UserIdentifier.html">UserIdentifier</a>
  
    <li><a href="./Vote.html">Vote</a>
  
    <li><a href="./VotesController.html">VotesController</a>
  
    <li><a href="./WelcomeController.html">WelcomeController</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation">
  <h1 class="class">class HgvMetaIdentifiersController</h1>

  <div id="description" class="description">
    
<p>Controller for all actions concerning the hgv metadata editor, such as
edit, update, show preview and some json actions for interactive javascript</p>

  </div><!-- description -->

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    

    <!-- Methods -->
    
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Instance Methods</h3>

    
      <div id="method-i-edit" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">edit</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Retrieves hgv identifier object from database and calls up HGV metadata
editor Assumes that incoming post respectively get parameters contain a
valid hgv identifier id Side effect on +@identifier+</p>
          

          
          <div class="method-source-code" id="edit-source">
            <pre><span class="ruby-comment"># File app/controllers/hgv_meta_identifiers_controller.rb, line 16</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">edit</span>
  <span class="ruby-identifier">find_identifier</span>
  <span class="ruby-ivar">@identifier</span>.<span class="ruby-identifier">get_epidoc_attributes</span>
  <span class="ruby-ivar">@is_editor_view</span> = <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- edit-source -->
          
        </div>

        

        
      </div><!-- edit-method -->

    
      <div id="method-i-get_date_preview" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_date_preview</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Provides a small data preview snippets (values for when, notBefore and
notAfter as well as the hgv formatted value) for display within the hgv
metadata editor Assumes that hgv metadata is passed in via post and uses
the values containd in hash entry »:textDate« to generate preview
snippets for hgv date. Side effect on +@update+</p>
          

          
          <div class="method-source-code" id="get_date_preview-source">
            <pre><span class="ruby-comment"># File app/controllers/hgv_meta_identifiers_controller.rb, line 70</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_date_preview</span>
  <span class="ruby-ivar">@updates</span> = {}

  [<span class="ruby-value">:X</span>, <span class="ruby-value">:Y</span>, <span class="ruby-value">:Z</span>].<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">dateId</span><span class="ruby-operator">|</span>
   <span class="ruby-identifier">index</span> = (<span class="ruby-string">'X'</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">-</span> <span class="ruby-identifier">dateId</span>.<span class="ruby-identifier">to_s</span>[<span class="ruby-value">0</span>]).<span class="ruby-identifier">abs</span>.<span class="ruby-identifier">to_s</span>
     <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:hgv_meta_identifier</span>][<span class="ruby-value">:textDate</span>][<span class="ruby-identifier">index</span>]
       <span class="ruby-ivar">@updates</span>[<span class="ruby-identifier">dateId</span>] = {
         <span class="ruby-value">:when</span>      =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:hgv_meta_identifier</span>][<span class="ruby-value">:textDate</span>][<span class="ruby-identifier">index</span>][<span class="ruby-value">:attributes</span>][<span class="ruby-value">:when</span>],
         <span class="ruby-value">:notBefore</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:hgv_meta_identifier</span>][<span class="ruby-value">:textDate</span>][<span class="ruby-identifier">index</span>][<span class="ruby-value">:attributes</span>][<span class="ruby-value">:notBefore</span>],
         <span class="ruby-value">:notAfter</span>  =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:hgv_meta_identifier</span>][<span class="ruby-value">:textDate</span>][<span class="ruby-identifier">index</span>][<span class="ruby-value">:attributes</span>][<span class="ruby-value">:notAfter</span>],
         <span class="ruby-value">:format</span>   =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:hgv_meta_identifier</span>][<span class="ruby-value">:textDate</span>][<span class="ruby-identifier">index</span>][<span class="ruby-value">:value</span>]
       }
     <span class="ruby-keyword">end</span>
  }
      
  <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">format</span>.<span class="ruby-identifier">js</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_date_preview-source -->
          
        </div>

        

        
      </div><!-- get_date_preview-method -->

    
      <div id="method-i-get_geo_preview" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_geo_preview</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Takes user’s geo data from post stream and generates a hgv formatted
preview from it Assumes that hgv post data (especially all data fields
concerning provenance) is passed in Side effect on +@identifier+ and
+@update+</p>
          

          
          <div class="method-source-code" id="get_geo_preview-source">
            <pre><span class="ruby-comment"># File app/controllers/hgv_meta_identifiers_controller.rb, line 93</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_geo_preview</span>
  <span class="ruby-ivar">@identifier</span> = <span class="ruby-constant">HGVMetaIdentifier</span>.<span class="ruby-identifier">new</span>
  <span class="ruby-ivar">@identifier</span>.<span class="ruby-identifier">populate_epidoc_attributes_from_attributes_hash</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:hgv_meta_identifier</span>]
  <span class="ruby-ivar">@update</span> = <span class="ruby-constant">HgvProvenance</span>.<span class="ruby-identifier">format</span> <span class="ruby-ivar">@identifier</span>[<span class="ruby-value">:provenance</span>]

  <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">format</span>.<span class="ruby-identifier">js</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_geo_preview-source -->
          
        </div>

        

        
      </div><!-- get_geo_preview-method -->

    
      <div id="method-i-preview" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">preview</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Retrieves an hgv identifier record by an incoming identifier id and creates
a preview Side effect on +@identifier+</p>
          

          
          <div class="method-source-code" id="preview-source">
            <pre><span class="ruby-comment"># File app/controllers/hgv_meta_identifiers_controller.rb, line 51</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">preview</span>
  <span class="ruby-identifier">find_identifier</span>
  <span class="ruby-ivar">@identifier</span>.<span class="ruby-identifier">get_epidoc_attributes</span>
  <span class="ruby-ivar">@is_editor_view</span> = <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- preview-source -->
          
        </div>

        

        
      </div><!-- preview-method -->

    
      <div id="method-i-update" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">update</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Retrieves hgv identifier object from database and updates its values from
incoming post data, saves comment Redirects back to the editor (see action
edit) Assumes that incoming post request contains new values for the hgv
record that should be written back to EpiDoc Side effect on +@identifier+
and <code>flash</code> Writes to database and git repository, clears
publication cache</p>
          

          
          <div class="method-source-code" id="update-source">
            <pre><span class="ruby-comment"># File app/controllers/hgv_meta_identifiers_controller.rb, line 27</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">update</span>
  <span class="ruby-identifier">find_identifier</span>
  <span class="ruby-comment">#exit</span>
  <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">commit_sha</span> = <span class="ruby-ivar">@identifier</span>.<span class="ruby-identifier">set_epidoc</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:hgv_meta_identifier</span>], <span class="ruby-identifier">params</span>[<span class="ruby-value">:comment</span>])
    <span class="ruby-identifier">expire_publication_cache</span>
    <span class="ruby-identifier">generate_flash_message</span>
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">JRubyXML</span><span class="ruby-operator">::</span><span class="ruby-constant">ParseError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
    <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-node">&quot;Error updating file: #{e.message}. This file was NOT SAVED.&quot;</span>
    <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">polymorphic_path</span>([<span class="ruby-ivar">@identifier</span>.<span class="ruby-identifier">publication</span>, <span class="ruby-ivar">@identifier</span>],
                                 <span class="ruby-value">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:edit</span>)
    <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>
  
  <span class="ruby-identifier">save_comment</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:comment</span>], <span class="ruby-identifier">commit_sha</span>)
  
  <span class="ruby-identifier">flash</span>[<span class="ruby-value">:expansionSet</span>] = <span class="ruby-identifier">params</span>[<span class="ruby-value">:expansionSet</span>]

  <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">polymorphic_path</span>([<span class="ruby-ivar">@identifier</span>.<span class="ruby-identifier">publication</span>, <span class="ruby-ivar">@identifier</span>],
                               <span class="ruby-value">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:edit</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- update-source -->
          
        </div>

        

        
      </div><!-- update-method -->

    
    </section><!-- public-instance-method-details -->
  
     <section id="protected-instance-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Protected Instance Methods</h3>

    
      <div id="method-i-complement_params" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">complement_params</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Adds additional information to incoming post data (e.g. adds hgv formatted
date string for each date records provided by the user) Assumes that hgv
metadata post data is passed in Complements incoming form data for hash
entries <code>:textDate</code>, <code>:mentionedDate</code> and
<code>provenance</code> Side effect on params variable</p>
          

          
          <div class="method-source-code" id="complement_params-source">
            <pre><span class="ruby-comment"># File app/controllers/hgv_meta_identifiers_controller.rb, line 154</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">complement_params</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:hgv_meta_identifier</span>]

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:hgv_meta_identifier</span>][<span class="ruby-value">:textDate</span>]
      <span class="ruby-identifier">params</span>[<span class="ruby-value">:hgv_meta_identifier</span>][<span class="ruby-value">:textDate</span>].<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">index</span>, <span class="ruby-identifier">date</span><span class="ruby-operator">|</span> <span class="ruby-comment"># for each textDate, i.e. X, Y, Z</span>
        <span class="ruby-identifier">date</span>[<span class="ruby-value">:id</span>] = <span class="ruby-identifier">date</span>[<span class="ruby-value">:attributes</span>][<span class="ruby-value">:id</span>]
        <span class="ruby-identifier">date</span>.<span class="ruby-identifier">delete_if</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-operator">!</span><span class="ruby-identifier">v</span>.<span class="ruby-identifier">instance_of?</span>(<span class="ruby-constant">String</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">v</span>.<span class="ruby-identifier">empty?</span> }
        <span class="ruby-identifier">params</span>[<span class="ruby-value">:hgv_meta_identifier</span>][<span class="ruby-value">:textDate</span>][<span class="ruby-identifier">index</span>] = <span class="ruby-constant">HgvDate</span>.<span class="ruby-identifier">hgvToEpidoc</span> <span class="ruby-identifier">date</span>
      }
    <span class="ruby-keyword">end</span>
    
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:hgv_meta_identifier</span>][<span class="ruby-value">:mentionedDate</span>]
      <span class="ruby-identifier">params</span>[<span class="ruby-value">:hgv_meta_identifier</span>][<span class="ruby-value">:mentionedDate</span>].<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">index</span>, <span class="ruby-identifier">date</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">date</span>[<span class="ruby-value">:children</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">date</span>[<span class="ruby-value">:children</span>][<span class="ruby-value">:date</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">date</span>[<span class="ruby-value">:children</span>][<span class="ruby-value">:date</span>][<span class="ruby-value">:attributes</span>]
          <span class="ruby-identifier">date</span>[<span class="ruby-value">:children</span>][<span class="ruby-value">:date</span>][<span class="ruby-value">:value</span>] = <span class="ruby-constant">HgvFormat</span>.<span class="ruby-identifier">formatDateFromIsoParts</span>(<span class="ruby-identifier">date</span>[<span class="ruby-value">:children</span>][<span class="ruby-value">:date</span>][<span class="ruby-value">:attributes</span>][<span class="ruby-value">:when</span>], <span class="ruby-identifier">date</span>[<span class="ruby-value">:children</span>][<span class="ruby-value">:date</span>][<span class="ruby-value">:attributes</span>][<span class="ruby-value">:notBefore</span>], <span class="ruby-identifier">date</span>[<span class="ruby-value">:children</span>][<span class="ruby-value">:date</span>][<span class="ruby-value">:attributes</span>][<span class="ruby-value">:notAfter</span>], <span class="ruby-identifier">date</span>[<span class="ruby-value">:certaintyPicker</span>]) <span class="ruby-comment"># cl: using date[:certaintyPicker] here is actually a hack</span>
        <span class="ruby-keyword">end</span>
      }
    <span class="ruby-keyword">end</span>
    
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:hgv_meta_identifier</span>][<span class="ruby-value">:provenance</span>]
      <span class="ruby-identifier">hgv</span> = <span class="ruby-constant">HGVMetaIdentifier</span>.<span class="ruby-identifier">new</span>
      <span class="ruby-identifier">hgv</span>.<span class="ruby-identifier">populate_epidoc_attributes_from_attributes_hash</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:hgv_meta_identifier</span>]
      <span class="ruby-identifier">params</span>[<span class="ruby-value">:hgv_meta_identifier</span>][<span class="ruby-value">:origPlace</span>] = <span class="ruby-constant">HgvProvenance</span>.<span class="ruby-identifier">format</span> <span class="ruby-identifier">hgv</span>[<span class="ruby-value">:provenance</span>]

    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">params</span>[<span class="ruby-value">:hgv_meta_identifier</span>][<span class="ruby-value">:origPlace</span>] = <span class="ruby-string">'unbekannt'</span>
    <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">end</span>

<span class="ruby-keyword">end</span></pre>
          </div><!-- complement_params-source -->
          
        </div>

        

        
      </div><!-- complement_params-method -->

    
      <div id="method-i-find_identifier" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">find_identifier</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Retrieves hgv identifier from database by id which it takes from the
incoming post stream Assumes that post data contains hgv identifier id Side
effect on +@identifier+</p>
          

          
          <div class="method-source-code" id="find_identifier-source">
            <pre><span class="ruby-comment"># File app/controllers/hgv_meta_identifiers_controller.rb, line 212</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">find_identifier</span>
  <span class="ruby-ivar">@identifier</span> = <span class="ruby-constant">HGVMetaIdentifier</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>])
<span class="ruby-keyword">end</span></pre>
          </div><!-- find_identifier-source -->
          
        </div>

        

        
      </div><!-- find_identifier-method -->

    
      <div id="method-i-generate_flash_message" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">generate_flash_message</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Writes some helpful status information for the user, e.g. ‘File update’
plus some quick links to guide the user’s subsequent actions Side effect
on flash#, i.e. +<a href="http://:notice">flash</a>+</p>
          

          
          <div class="method-source-code" id="generate_flash_message-source">
            <pre><span class="ruby-comment"># File app/controllers/hgv_meta_identifiers_controller.rb, line 189</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">generate_flash_message</span>
  <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-string">&quot;File updated.&quot;</span>
  <span class="ruby-keyword">if</span> <span class="ruby-node">%w{new editing}</span>.<span class="ruby-identifier">include?</span> <span class="ruby-ivar">@identifier</span>.<span class="ruby-identifier">publication</span>.<span class="ruby-identifier">status</span>
    <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] <span class="ruby-operator">+=</span> <span class="ruby-node">&quot; Go to the &lt;a href='#{url_for(@identifier.publication)}'&gt;publication overview&lt;/a&gt; if you would like to submit.&quot;</span>
  <span class="ruby-keyword">end</span>      
<span class="ruby-keyword">end</span></pre>
          </div><!-- generate_flash_message-source -->
          
        </div>

        

        
      </div><!-- generate_flash_message-method -->

    
      <div id="method-i-prune_params" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">prune_params</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Gets rid of invalid user data that has been passed in, such as empty fields
in publication information or dates don’t provide enough information to
be parsed as hgv dates Assumes that the hgv metadata editor has been called
to action and that its post data is passed in via post Prunes post
parameters for hash entries <code>:publicationExtra</code>,
<code>:textDate</code> and <code>:mentionedDate</code> Side effect on
params variable</p>
          

          
          <div class="method-source-code" id="prune_params-source">
            <pre><span class="ruby-comment"># File app/controllers/hgv_meta_identifiers_controller.rb, line 109</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">prune_params</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:hgv_meta_identifier</span>]

    <span class="ruby-comment"># get rid of empty publication parts</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:hgv_meta_identifier</span>][<span class="ruby-value">:publicationExtra</span>]
      <span class="ruby-identifier">params</span>[<span class="ruby-value">:hgv_meta_identifier</span>][<span class="ruby-value">:publicationExtra</span>].<span class="ruby-identifier">delete_if</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">index</span>, <span class="ruby-identifier">extra</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">extra</span>[<span class="ruby-value">:value</span>].<span class="ruby-identifier">empty?</span>
      }
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:hgv_meta_identifier</span>][<span class="ruby-value">:textDate</span>]
      
      <span class="ruby-comment"># get rid of empty (invalid) date items</span>
      <span class="ruby-identifier">params</span>[<span class="ruby-value">:hgv_meta_identifier</span>][<span class="ruby-value">:textDate</span>].<span class="ruby-identifier">delete_if</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">index</span>, <span class="ruby-identifier">date</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">date</span>[<span class="ruby-value">:c</span>].<span class="ruby-identifier">empty?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">date</span>[<span class="ruby-value">:y</span>].<span class="ruby-identifier">empty?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">date</span>[<span class="ruby-value">:unknown</span>]
      }

      <span class="ruby-comment"># get rid of unnecessary date attribute @xml:id if there is only one date</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:hgv_meta_identifier</span>][<span class="ruby-value">:textDate</span>].<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
        <span class="ruby-identifier">params</span>[<span class="ruby-value">:hgv_meta_identifier</span>][<span class="ruby-value">:textDate</span>][<span class="ruby-string">'0'</span>][<span class="ruby-value">:attributes</span>][<span class="ruby-value">:id</span>] = <span class="ruby-keyword">nil</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># get rid of empty certainties for mentioned dates (X, Y, Z)</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:hgv_meta_identifier</span>][<span class="ruby-string">'mentionedDate'</span>]
      <span class="ruby-identifier">params</span>[<span class="ruby-value">:hgv_meta_identifier</span>][<span class="ruby-string">'mentionedDate'</span>].<span class="ruby-identifier">each_pair</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">index</span>, <span class="ruby-identifier">date</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">date</span>[<span class="ruby-string">'children'</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">date</span>[<span class="ruby-string">'children'</span>][<span class="ruby-string">'date'</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">date</span>[<span class="ruby-string">'children'</span>][<span class="ruby-string">'date'</span>][<span class="ruby-string">'children'</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">date</span>[<span class="ruby-string">'children'</span>][<span class="ruby-string">'date'</span>][<span class="ruby-string">'children'</span>][<span class="ruby-string">'certainty'</span>]
          <span class="ruby-identifier">date</span>[<span class="ruby-string">'children'</span>][<span class="ruby-string">'date'</span>][<span class="ruby-string">'children'</span>][<span class="ruby-string">'certainty'</span>].<span class="ruby-identifier">each_pair</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">certainty_index</span>, <span class="ruby-identifier">certainty</span><span class="ruby-operator">|</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">certainty</span>[<span class="ruby-string">'attributes'</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">certainty</span>[<span class="ruby-string">'attributes'</span>][<span class="ruby-string">'relation'</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">certainty</span>[<span class="ruby-string">'attributes'</span>][<span class="ruby-string">'relation'</span>].<span class="ruby-identifier">empty?</span>
              <span class="ruby-identifier">date</span>[<span class="ruby-string">'children'</span>][<span class="ruby-string">'date'</span>][<span class="ruby-string">'children'</span>][<span class="ruby-string">'certainty'</span>].<span class="ruby-identifier">delete</span> <span class="ruby-identifier">certainty_index</span>
            <span class="ruby-keyword">end</span>
          }
        <span class="ruby-keyword">end</span>
      }
    <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">end</span>

<span class="ruby-keyword">end</span></pre>
          </div><!-- prune_params-source -->
          
        </div>

        

        
      </div><!-- prune_params-method -->

    
      <div id="method-i-save_comment" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">save_comment</span><span
            class="method-args">(comment, commit_sha)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Saves user’s comment on a save operation to the database</p>
<ul><li>
<p><strong>Args</strong>  :</p>
<ul><li>
<p><code>comment</code> → comment made by the user and passed in via post
parameters</p>
</li><li>
<p><code>commit_sha</code> → hash string of the corresponding git commit</p>
</li></ul>
</li></ul>

<p>Writes to database Side effect on +@comment+</p>
          

          
          <div class="method-source-code" id="save_comment-source">
            <pre><span class="ruby-comment"># File app/controllers/hgv_meta_identifiers_controller.rb, line 202</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">save_comment</span> (<span class="ruby-identifier">comment</span>, <span class="ruby-identifier">commit_sha</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">comment</span> <span class="ruby-operator">!=</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">comment</span>.<span class="ruby-identifier">strip</span> <span class="ruby-operator">!=</span> <span class="ruby-string">&quot;&quot;</span>
    <span class="ruby-ivar">@comment</span> = <span class="ruby-constant">Comment</span>.<span class="ruby-identifier">new</span>( {<span class="ruby-value">:git_hash</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">commit_sha</span>, <span class="ruby-value">:user_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@current_user</span>.<span class="ruby-identifier">id</span>, <span class="ruby-value">:identifier_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@identifier</span>.<span class="ruby-identifier">id</span>, <span class="ruby-value">:publication_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@identifier</span>.<span class="ruby-identifier">publication_id</span>, <span class="ruby-value">:comment</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">comment</span>, <span class="ruby-value">:reason</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;commit&quot;</span> } )
    <span class="ruby-ivar">@comment</span>.<span class="ruby-identifier">save</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- save_comment-source -->
          
        </div>

        

        
      </div><!-- save_comment-method -->

    
    </section><!-- protected-instance-method-details -->
  
  </section><!-- 5Buntitled-5D -->

</div><!-- documentation -->


<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 3.11.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>

