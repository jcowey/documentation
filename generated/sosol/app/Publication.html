<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">

<title>Class: Publication</title>

<link type="text/css" media="screen" href="./rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script type="text/javascript" charset="utf-8" src="./js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/darkfish.js"></script>


<body id="top" class="class">
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="./index.html">Home</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  <div id="file-metadata">
    <nav id="file-list-section" class="section">
  <h3 class="section-header">Defined In</h3>
  <ul>
    <li>app/models/publication.rb
  </ul>
</nav>

    
  </div>

  <div id="class-metadata">
    
    <nav id="parent-class-section" class="section">
  <h3 class="section-header">Parent</h3>
  
  <p class="link">ActiveRecord::Base
  
</nav>

    
    <!-- Method Quickref -->
<nav id="method-list-section" class="section">
  <h3 class="section-header">Methods</h3>

  <ul class="link-list">
    
    <li><a href="#method-c-new_from_templates">::new_from_templates</a>
    
    <li><a href="#method-i-after_create">#after_create</a>
    
    <li><a href="#method-i-after_destroy">#after_destroy</a>
    
    <li><a href="#method-i-all_children">#all_children</a>
    
    <li><a href="#method-i-allow_user_withdrawal-3F">#allow_user_withdrawal?</a>
    
    <li><a href="#method-i-archive">#archive</a>
    
    <li><a href="#method-i-before_create">#before_create</a>
    
    <li><a href="#method-i-before_validation">#before_validation</a>
    
    <li><a href="#method-i-branch_from_master">#branch_from_master</a>
    
    <li><a href="#method-i-canon_controlled_identifiers">#canon_controlled_identifiers</a>
    
    <li><a href="#method-i-canon_controlled_paths">#canon_controlled_paths</a>
    
    <li><a href="#method-i-change_finalizer">#change_finalizer</a>
    
    <li><a href="#method-i-change_status">#change_status</a>
    
    <li><a href="#method-i-children_votes">#children_votes</a>
    
    <li><a href="#method-i-clone_to_end_user">#clone_to_end_user</a>
    
    <li><a href="#method-i-clone_to_owner">#clone_to_owner</a>
    
    <li><a href="#method-i-commit_to_canon">#commit_to_canon</a>
    
    <li><a href="#method-i-controlled_identifiers">#controlled_identifiers</a>
    
    <li><a href="#method-i-controlled_paths">#controlled_paths</a>
    
    <li><a href="#method-i-copy_back_to_user">#copy_back_to_user</a>
    
    <li><a href="#method-i-copy_repo_to_parent_repo">#copy_repo_to_parent_repo</a>
    
    <li><a href="#method-i-copy_to_end_user">#copy_to_end_user</a>
    
    <li><a href="#method-i-copy_to_owner">#copy_to_owner</a>
    
    <li><a href="#method-i-creatable_identifiers">#creatable_identifiers</a>
    
    <li><a href="#method-i-diff_from_canon">#diff_from_canon</a>
    
    <li><a href="#method-i-entry_identifier">#entry_identifier</a>
    
    <li><a href="#method-i-find_finalizer_publication">#find_finalizer_publication</a>
    
    <li><a href="#method-i-find_finalizer_user">#find_finalizer_user</a>
    
    <li><a href="#method-i-find_first_board">#find_first_board</a>
    
    <li><a href="#method-i-find_first_board_parent">#find_first_board_parent</a>
    
    <li><a href="#method-i-flatten_commits">#flatten_commits</a>
    
    <li><a href="#method-i-get_all_comments">#get_all_comments</a>
    
    <li><a href="#method-i-head">#head</a>
    
    <li><a href="#method-i-identifier_to_ref">#identifier_to_ref</a>
    
    <li><a href="#method-i-is_community_publication-3F">#is_community_publication?</a>
    
    <li><a href="#method-i-log_info">#log_info</a>
    
    <li><a href="#method-i-merge_base">#merge_base</a>
    
    <li><a href="#method-i-modified-3F">#modified?</a>
    
    <li><a href="#method-i-mutable-3F">#mutable?</a>
    
    <li><a href="#method-i-mutable_by-3F">#mutable_by?</a>
    
    <li><a href="#method-i-origin">#origin</a>
    
    <li><a href="#method-i-populate_identifiers_from_identifiers">#populate_identifiers_from_identifiers</a>
    
    <li><a href="#method-i-print">#print</a>
    
    <li><a href="#method-i-remove_finalizer">#remove_finalizer</a>
    
    <li><a href="#method-i-repository">#repository</a>
    
    <li><a href="#method-i-send_to_finalizer">#send_to_finalizer</a>
    
    <li><a href="#method-i-set_board_identifier_status">#set_board_identifier_status</a>
    
    <li><a href="#method-i-set_local_identifier_status">#set_local_identifier_status</a>
    
    <li><a href="#method-i-set_origin_and_local_identifier_status">#set_origin_and_local_identifier_status</a>
    
    <li><a href="#method-i-set_origin_identifier_status">#set_origin_identifier_status</a>
    
    <li><a href="#method-i-submission_reason">#submission_reason</a>
    
    <li><a href="#method-i-submit">#submit</a>
    
    <li><a href="#method-i-submit_to_next_board">#submit_to_next_board</a>
    
    <li><a href="#method-i-tally_votes">#tally_votes</a>
    
    <li><a href="#method-i-title_to_ref">#title_to_ref</a>
    
    <li><a href="#method-i-user_has_voted-3F">#user_has_voted?</a>
    
    <li><a href="#method-i-withdraw">#withdraw</a>
    
  </ul>
</nav>

  </div>

  <div id="project-metadata">
    <nav id="fileindex-section" class="section project-section">
  <h3 class="section-header">Pages</h3>

  <ul>
  
    <li class="file"><a href="./doc/README_FOR_APP.html">README_FOR_APP</a>
  
  </ul>
</nav>

    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="./HgvMetaIdentifierHelper.html">HgvMetaIdentifierHelper</a>
  
    <li><a href="./HgvMetaIdentifierHelper/HgvDate.html">HgvMetaIdentifierHelper::HgvDate</a>
  
    <li><a href="./HgvMetaIdentifierHelper/HgvFormat.html">HgvMetaIdentifierHelper::HgvFormat</a>
  
    <li><a href="./HgvMetaIdentifierHelper/HgvFuzzy.html">HgvMetaIdentifierHelper::HgvFuzzy</a>
  
    <li><a href="./HgvMetaIdentifierHelper/HgvGeo.html">HgvMetaIdentifierHelper::HgvGeo</a>
  
    <li><a href="./HgvMetaIdentifierHelper/HgvGeo/GeoSpot.html">HgvMetaIdentifierHelper::HgvGeo::GeoSpot</a>
  
    <li><a href="./HgvMetaIdentifierHelper/HgvGeo/Place.html">HgvMetaIdentifierHelper::HgvGeo::Place</a>
  
    <li><a href="./HgvMetaIdentifierHelper/HgvGeo/Provenance.html">HgvMetaIdentifierHelper::HgvGeo::Provenance</a>
  
    <li><a href="./HgvMetaIdentifierHelper/HgvMentionedDate.html">HgvMetaIdentifierHelper::HgvMentionedDate</a>
  
    <li><a href="./HgvMetaIdentifierHelper/HgvProvenance.html">HgvMetaIdentifierHelper::HgvProvenance</a>
  
    <li><a href="./HgvMetaIdentifierHelper/HgvPublication.html">HgvMetaIdentifierHelper::HgvPublication</a>
  
    <li><a href="./BiblioIdentifier.html">BiblioIdentifier</a>
  
    <li><a href="./BiblioIdentifier/Container.html">BiblioIdentifier::Container</a>
  
    <li><a href="./BiblioIdentifier/Note.html">BiblioIdentifier::Note</a>
  
    <li><a href="./BiblioIdentifier/PublicationPerson.html">BiblioIdentifier::PublicationPerson</a>
  
    <li><a href="./BiblioIdentifier/Publisher.html">BiblioIdentifier::Publisher</a>
  
    <li><a href="./BiblioIdentifier/RelatedArticle.html">BiblioIdentifier::RelatedArticle</a>
  
    <li><a href="./BiblioIdentifier/RelatedItem.html">BiblioIdentifier::RelatedItem</a>
  
    <li><a href="./BiblioIdentifier/Reviewee.html">BiblioIdentifier::Reviewee</a>
  
    <li><a href="./BiblioIdentifier/ShortTitle.html">BiblioIdentifier::ShortTitle</a>
  
    <li><a href="./JRubyXML.html">JRubyXML</a>
  
    <li><a href="./JRubyXML/EpiDocP4Validator.html">JRubyXML::EpiDocP4Validator</a>
  
    <li><a href="./JRubyXML/EpiDocP5Validator.html">JRubyXML::EpiDocP5Validator</a>
  
    <li><a href="./JRubyXML/JARVValidator.html">JRubyXML::JARVValidator</a>
  
    <li><a href="./JRubyXML/NamespaceContext.html">JRubyXML::NamespaceContext</a>
  
    <li><a href="./JRubyXML/ParseError.html">JRubyXML::ParseError</a>
  
    <li><a href="./JRubyXML/ParseErrorHandler.html">JRubyXML::ParseErrorHandler</a>
  
    <li><a href="./JRubyXML/RDFValidator.html">JRubyXML::RDFValidator</a>
  
    <li><a href="./JRubyXML/TransformErrorListener.html">JRubyXML::TransformErrorListener</a>
  
    <li><a href="./REXML.html">REXML</a>
  
    <li><a href="./REXML/Document.html">REXML::Document</a>
  
    <li><a href="./REXML/Element.html">REXML::Element</a>
  
    <li><a href="./REXML/XPath.html">REXML::XPath</a>
  
    <li><a href="./NumbersRDF.html">NumbersRDF</a>
  
    <li><a href="./NumbersRDF/NumbersHelper.html">NumbersRDF::NumbersHelper</a>
  
    <li><a href="./NumbersRDF/Timeout.html">NumbersRDF::Timeout</a>
  
    <li><a href="./Rpx.html">Rpx</a>
  
    <li><a href="./Rpx/RpxException.html">Rpx::RpxException</a>
  
    <li><a href="./Rpx/RpxHelper.html">Rpx::RpxHelper</a>
  
    <li><a href="./Comment.html">Comment</a>
  
    <li><a href="./Comment/CombineComment.html">Comment::CombineComment</a>
  
    <li><a href="./Doco.html">Doco</a>
  
    <li><a href="./Doco/DocoNode.html">Doco::DocoNode</a>
  
    <li><a href="./Grit.html">Grit</a>
  
    <li><a href="./Grit/Commit.html">Grit::Commit</a>
  
    <li><a href="./HGVMetaIdentifier.html">HGVMetaIdentifier</a>
  
    <li><a href="./HGVMetaIdentifier/HgvMetaConfiguration.html">HGVMetaIdentifier::HgvMetaConfiguration</a>
  
    <li><a href="./HGVTransGlossary.html">HGVTransGlossary</a>
  
    <li><a href="./HGVTransGlossary/Entry.html">HGVTransGlossary::Entry</a>
  
    <li><a href="./APISIdentifier.html">APISIdentifier</a>
  
    <li><a href="./AjaxProxyController.html">AjaxProxyController</a>
  
    <li><a href="./ApplicationController.html">ApplicationController</a>
  
    <li><a href="./ApplicationHelper.html">ApplicationHelper</a>
  
    <li><a href="./BiblioFormBuilder.html">BiblioFormBuilder</a>
  
    <li><a href="./BiblioIdentifiersController.html">BiblioIdentifiersController</a>
  
    <li><a href="./Board.html">Board</a>
  
    <li><a href="./BoardsController.html">BoardsController</a>
  
    <li><a href="./CollectionIdentifier.html">CollectionIdentifier</a>
  
    <li><a href="./CollectionIdentifiersController.html">CollectionIdentifiersController</a>
  
    <li><a href="./CommentsController.html">CommentsController</a>
  
    <li><a href="./CommunitiesController.html">CommunitiesController</a>
  
    <li><a href="./Community.html">Community</a>
  
    <li><a href="./CrossSiteController.html">CrossSiteController</a>
  
    <li><a href="./DDBIdentifier.html">DDBIdentifier</a>
  
    <li><a href="./DdbIdentifiersController.html">DdbIdentifiersController</a>
  
    <li><a href="./Decree.html">Decree</a>
  
    <li><a href="./DecreesController.html">DecreesController</a>
  
    <li><a href="./DocosController.html">DocosController</a>
  
    <li><a href="./DocovideosController.html">DocovideosController</a>
  
    <li><a href="./Emailer.html">Emailer</a>
  
    <li><a href="./EmailerMailer.html">EmailerMailer</a>
  
    <li><a href="./EmailersController.html">EmailersController</a>
  
    <li><a href="./Event.html">Event</a>
  
    <li><a href="./EventsController.html">EventsController</a>
  
    <li><a href="./GitConf.html">GitConf</a>
  
    <li><a href="./HGVIdentifier.html">HGVIdentifier</a>
  
    <li><a href="./HGVTransIdentifier.html">HGVTransIdentifier</a>
  
    <li><a href="./HelperController.html">HelperController</a>
  
    <li><a href="./HgvMetaIdentifiersController.html">HgvMetaIdentifiersController</a>
  
    <li><a href="./HgvTransGlossariesController.html">HgvTransGlossariesController</a>
  
    <li><a href="./HgvTransIdentifiersController.html">HgvTransIdentifiersController</a>
  
    <li><a href="./Identifier.html">Identifier</a>
  
    <li><a href="./IdentifiersController.html">IdentifiersController</a>
  
    <li><a href="./Integer.html">Integer</a>
  
    <li><a href="./Leiden.html">Leiden</a>
  
    <li><a href="./LeidenController.html">LeidenController</a>
  
    <li><a href="./LinkingInfo.html">LinkingInfo</a>
  
    <li><a href="./MaintenanceMode.html">MaintenanceMode</a>
  
    <li><a href="./Object.html">Object</a>
  
    <li><a href="./PrettySsime.html">PrettySsime</a>
  
    <li><a href="./Publication.html">Publication</a>
  
    <li><a href="./PublicationsController.html">PublicationsController</a>
  
    <li><a href="./Rails.html">Rails</a>
  
    <li><a href="./RepositoriesController.html">RepositoriesController</a>
  
    <li><a href="./Repository.html">Repository</a>
  
    <li><a href="./RpxController.html">RpxController</a>
  
    <li><a href="./TranslationHelperController.html">TranslationHelperController</a>
  
    <li><a href="./TranslationLeiden.html">TranslationLeiden</a>
  
    <li><a href="./TranslationLeidenController.html">TranslationLeidenController</a>
  
    <li><a href="./User.html">User</a>
  
    <li><a href="./UserController.html">UserController</a>
  
    <li><a href="./UserIdentifier.html">UserIdentifier</a>
  
    <li><a href="./Vote.html">Vote</a>
  
    <li><a href="./VotesController.html">VotesController</a>
  
    <li><a href="./WelcomeController.html">WelcomeController</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation">
  <h1 class="class">class Publication</h1>

  <div id="description" class="description">
    
<p>A publication is the basic object of the editorial workflow. The
publication consists of a collection of identifiers. The publication has a
branch which contains the identifiers. A user creates a publication.
Modifies the publication and submits it to the boards. Each board will get
a copy of the user’s publication (the origin publication) to work with.
Upon approval, the finalizer will receive a copy of the publication to work
with. The finalizer’s, and board’s copies are all children of the
origin copy.</p>

<p>This class contains many of the methods that controls the workflow for the
publication. Examples are:</p>
<ul><li>
<p>publicaiton creation</p>
</li><li>
<p>copying of a publication</p>
</li><li>
<p>changeing the status of a publication</p>
</li><li>
<p>determining which board examines the publication</p>
</li><li>
<p>determining voting outcome</p>
</li><li>
<p>commiting to canon</p>
</li></ul>

  </div><!-- description -->

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    
    <!-- Constants -->
    <section id="constants-list" class="section">
      <h3 class="section-header">Constants</h3>
      <dl>
      
        <dt id="PUBLICATION_STATUS">PUBLICATION_STATUS
        
        <dd class="description">
        
      
      </dl>
    </section>
    

    
    <!-- Attributes -->
    <section id="attribute-method-details" class="method-section section">
      <h3 class="section-header">Attributes</h3>

      
      <div id="attribute-i-recent_submit_sha" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">recent_submit_sha</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>inelegant way to pass this info, but it works</p>
        
        </div>
      </div>
      
    </section><!-- attribute-method-details -->
    

    <!-- Methods -->
    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Class Methods</h3>

    
      <div id="method-c-new_from_templates" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_from_templates</span><span
            class="method-args">(creator)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Creates a new publication from templates found in app/data/templates. The
new publication contains a <a href="DDBIdentifier.html">DDBIdentifier</a>
and a <a href="HGVMetaIdentifier.html">HGVMetaIdentifier</a></p>

<p><strong>Args</strong>:  -<code>creator</code> the user who will be the
owner of the publication.</p>

<p><strong>Returns</strong>: the new publication consiting of a <a
href="DDBIdentifier.html">DDBIdentifier</a> and an <a
href="HGVMetaIdentifier.html">HGVMetaIdentifier</a></p>
          

          
          <div class="method-source-code" id="new_from_templates-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 412</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">new_from_templates</span>(<span class="ruby-identifier">creator</span>)
  <span class="ruby-identifier">new_publication</span> = <span class="ruby-constant">Publication</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">:owner</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">creator</span>, <span class="ruby-value">:creator</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">creator</span>)
  
  <span class="ruby-comment"># fetch a title without creating from template</span>
  <span class="ruby-identifier">new_publication</span>.<span class="ruby-identifier">title</span> = <span class="ruby-constant">DDBIdentifier</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">DDBIdentifier</span>.<span class="ruby-identifier">next_temporary_identifier</span>).<span class="ruby-identifier">titleize</span>
  
  <span class="ruby-identifier">new_publication</span>.<span class="ruby-identifier">status</span> = <span class="ruby-string">&quot;new&quot;</span> <span class="ruby-comment">#TODO add new flag else where or flesh out new status#&quot;new&quot;</span>
  
  <span class="ruby-identifier">new_publication</span>.<span class="ruby-identifier">save!</span>
  
  <span class="ruby-comment"># branch from master so we aren't just creating an empty branch</span>
  <span class="ruby-identifier">new_publication</span>.<span class="ruby-identifier">branch_from_master</span>
          
  <span class="ruby-comment">#create the required meta data and transcriptions</span>
  <span class="ruby-identifier">new_ddb</span> = <span class="ruby-constant">DDBIdentifier</span>.<span class="ruby-identifier">new_from_template</span>(<span class="ruby-identifier">new_publication</span>)      
  <span class="ruby-identifier">new_hgv_meta</span> = <span class="ruby-constant">HGVMetaIdentifier</span>.<span class="ruby-identifier">new_from_template</span>(<span class="ruby-identifier">new_publication</span>)
          
  <span class="ruby-comment"># go ahead and create the third so we can get rid of the create button</span>
  <span class="ruby-comment">#new_hgv_trans = HGVTransIdentifier.new_from_template(new_publication)    </span>
  
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">new_publication</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- new_from_templates-source -->
          
        </div>

        

        
      </div><!-- new_from_templates-method -->

    
    </section><!-- public-class-method-details -->
  
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Instance Methods</h3>

    
      <div id="method-i-after_create" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">after_create</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>TODO: rename actual branch after branch attribute rename</p>
          

          
          <div class="method-source-code" id="after_create-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 476</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">after_create</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- after_create-source -->
          
        </div>

        

        
      </div><!-- after_create-method -->

    
      <div id="method-i-after_destroy" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">after_destroy</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="after_destroy-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 184</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">after_destroy</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">delete_branch</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">branch</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- after_destroy-source -->
          
        </div>

        

        
      </div><!-- after_destroy-method -->

    
      <div id="method-i-all_children" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">all_children</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p><strong>Returns</strong> <code>array</code> of all of this publication’s
children.</p>
          

          
          <div class="method-source-code" id="all_children-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 1193</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">all_children</span>
  <span class="ruby-identifier">all_child_publications</span> = []
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">children</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">child_publication</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">all_child_publications</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">child_publication</span>
    <span class="ruby-identifier">all_child_publications</span> = <span class="ruby-identifier">all_child_publications</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">child_publication</span>.<span class="ruby-identifier">all_children</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">all_child_publications</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- all_children-source -->
          
        </div>

        

        
      </div><!-- all_children-method -->

    
      <div id="method-i-allow_user_withdrawal-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">allow_user_withdrawal?</span><span
            class="method-args">(user)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Checks to see if user should be allowed to withdraw their submitted
publication.</p>

<p><strong>Returns</strong></p>
<ul><li>
<p><code>true</code> if user can withdraw publication. Currently the rule is
the user can withdraw before any voting has taken place.</p>
</li><li>
<p><code>false</code> if the user can no longer withdraw the publication.</p>
</li></ul>
          

          
          <div class="method-source-code" id="allow_user_withdrawal-3F-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 1226</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">allow_user_withdrawal?</span>(<span class="ruby-identifier">user</span>)
  <span class="ruby-comment">#check any children publications for voting activity</span>
  <span class="ruby-identifier">vote_count</span> = <span class="ruby-value">0</span>;
  
  <span class="ruby-identifier">child_publications</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">all_children</span>
  <span class="ruby-identifier">child_publications</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">pub</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">vote_count</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">pub</span>.<span class="ruby-identifier">votes</span>.<span class="ruby-identifier">count</span>
  <span class="ruby-keyword">end</span>
 <span class="ruby-keyword">return</span> ( <span class="ruby-identifier">vote_count</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">1</span> ) <span class="ruby-operator">&amp;&amp;</span> ( <span class="ruby-identifier">user</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">creator</span> ) <span class="ruby-operator">&amp;&amp;</span> ( <span class="ruby-keyword">self</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">==</span> <span class="ruby-string">'submitted'</span> )
<span class="ruby-keyword">end</span></pre>
          </div><!-- allow_user_withdrawal-3F-source -->
          
        </div>

        

        
      </div><!-- allow_user_withdrawal-3F-method -->

    
      <div id="method-i-archive" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">archive</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Sets the status to archived and renames the title with the date-time to
prevent future title collisions.</p>
          

          
          <div class="method-source-code" id="archive-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 572</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">archive</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">change_status</span>(<span class="ruby-string">&quot;archived&quot;</span>)
  
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">title</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">title</span> <span class="ruby-operator">+</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot; (%Y/%m/%d-%H.%M.%S)&quot;</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">save!</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- archive-source -->
          
        </div>

        

        
      </div><!-- archive-method -->

    
      <div id="method-i-before_create" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">before_create</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Should check the owner’s repo to make sure the branch doesn’t exist and
halt if so</p>
          

          
          <div class="method-source-code" id="before_create-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 178</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">before_create</span>
  <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">branches</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">branch</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- before_create-source -->
          
        </div>

        

        
      </div><!-- before_create-method -->

    
      <div id="method-i-before_validation" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">before_validation</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>If branch hasn’t been specified, create it from the title before
validation, replacing spaces with underscore. TODO: do a branch rename
inside before_validation_on_update?</p>
          

          
          <div class="method-source-code" id="before_validation-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 173</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">before_validation</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">branch</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">title_to_ref</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">title</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- before_validation-source -->
          
        </div>

        

        
      </div><!-- before_validation-method -->

    
      <div id="method-i-branch_from_master" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">branch_from_master</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="branch_from_master-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 1122</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">branch_from_master</span>
  <span class="ruby-identifier">owner</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">create_branch</span>(<span class="ruby-identifier">branch</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- branch_from_master-source -->
          
        </div>

        

        
      </div><!-- branch_from_master-method -->

    
      <div id="method-i-canon_controlled_identifiers" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">canon_controlled_identifiers</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="canon_controlled_identifiers-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 1155</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">canon_controlled_identifiers</span>
  <span class="ruby-comment"># TODO: implement a class-level var e.g. CANON_CONTROL for this</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">controlled_identifiers</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- canon_controlled_identifiers-source -->
          
        </div>

        

        
      </div><!-- canon_controlled_identifiers-method -->

    
      <div id="method-i-canon_controlled_paths" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">canon_controlled_paths</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="canon_controlled_paths-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 1160</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">canon_controlled_paths</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">canon_controlled_identifiers</span>.<span class="ruby-identifier">collect</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">i</span>.<span class="ruby-identifier">to_path</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- canon_controlled_paths-source -->
          
        </div>

        

        
      </div><!-- canon_controlled_paths-method -->

    
      <div id="method-i-change_finalizer" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">change_finalizer</span><span
            class="method-args">(new_finalizer)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="change_finalizer-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 845</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">change_finalizer</span>(<span class="ruby-identifier">new_finalizer</span>)
    <span class="ruby-comment">#need to copy finalizer's copy if they have changed anything</span>
    <span class="ruby-comment">#copy board pub to new finalizer</span>
    <span class="ruby-identifier">old_finalizing_publication</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">find_finalizer_publication</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">old_finalizing_publication</span>.<span class="ruby-identifier">nil?</span>
      <span class="ruby-comment">#some kind of error should be thrown?</span>
      <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">error</span>(<span class="ruby-string">&quot;Attempt to change finalizer on nonexistent finalize publication &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">title</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot; .&quot;</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-comment">#    if old_finalizing_publication</span>
<span class="ruby-comment">#      new_finalizing_publication = old_finalizing_publication.copy_to_owner(new_finalizer) #clone_to_owner(new_finalizer)</span>
<span class="ruby-comment">#      new_finalizing_publication.parent = old_finalizing_publication.parent</span>
<span class="ruby-comment">#      new_finalizing_publication.save!</span>
<span class="ruby-comment">#    end</span>
    
    <span class="ruby-comment">#remove former finalizer</span>
<span class="ruby-comment">#    old_finalizing_publication.destroy</span>
   
   
   <span class="ruby-comment">#########</span>
    <span class="ruby-comment">#---clone to owner</span>
    <span class="ruby-identifier">new_finalizing_publication</span> = <span class="ruby-identifier">old_finalizing_publication</span>.<span class="ruby-identifier">clone</span>
    <span class="ruby-identifier">new_finalizing_publication</span>.<span class="ruby-identifier">owner</span> = <span class="ruby-identifier">new_finalizer</span>
    <span class="ruby-identifier">new_finalizing_publication</span>.<span class="ruby-identifier">creator</span> = <span class="ruby-identifier">old_finalizing_publication</span>.<span class="ruby-identifier">creator</span>
    <span class="ruby-identifier">new_finalizing_publication</span>.<span class="ruby-identifier">title</span> = <span class="ruby-identifier">old_finalizing_publication</span>.<span class="ruby-identifier">title</span>
    <span class="ruby-identifier">new_finalizing_publication</span>.<span class="ruby-identifier">branch</span> = <span class="ruby-identifier">title_to_ref</span>(<span class="ruby-identifier">new_finalizing_publication</span>.<span class="ruby-identifier">title</span>)
    <span class="ruby-identifier">new_finalizing_publication</span>.<span class="ruby-identifier">parent</span> = <span class="ruby-identifier">old_finalizing_publication</span>.<span class="ruby-identifier">parent</span>
    
    <span class="ruby-identifier">new_finalizing_publication</span>.<span class="ruby-identifier">save!</span>
    
    <span class="ruby-comment"># copy identifiers over to new pub</span>
    <span class="ruby-identifier">old_finalizing_publication</span>.<span class="ruby-identifier">identifiers</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">identifier</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">duplicate_identifier</span> = <span class="ruby-identifier">identifier</span>.<span class="ruby-identifier">clone</span>
      <span class="ruby-identifier">new_finalizing_publication</span>.<span class="ruby-identifier">identifiers</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">duplicate_identifier</span>
    <span class="ruby-keyword">end</span>
   <span class="ruby-comment">#===clone to owner</span>
   
   <span class="ruby-identifier">new_finalizing_publication</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">copy_branch_from_repo</span>( <span class="ruby-identifier">old_finalizing_publication</span>.<span class="ruby-identifier">branch</span>, <span class="ruby-identifier">new_finalizing_publication</span>.<span class="ruby-identifier">branch</span>, <span class="ruby-identifier">old_finalizing_publication</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">repository</span>)
   <span class="ruby-identifier">new_finalizing_publication</span>.<span class="ruby-identifier">save!</span>
   
   <span class="ruby-identifier">old_finalizing_publication</span>.<span class="ruby-identifier">destroy</span>
   <span class="ruby-comment">#######</span>
   
   <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
   
   
    <span class="ruby-comment">#now there are 2 finalizers, any danger in this?</span>
    <span class="ruby-comment">#now copy any old changes to new</span>
    
    
    <span class="ruby-comment">#copy old finalizer's changes to new finalizer</span>
    <span class="ruby-comment">#maybe just change owner? creator? but then need to copy over</span>
    
  <span class="ruby-keyword">end</span></pre>
          </div><!-- change_finalizer-source -->
          
        </div>

        

        
      </div><!-- change_finalizer-method -->

    
      <div id="method-i-change_status" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">change_status</span><span
            class="method-args">(new_status)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="change_status-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 538</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">change_status</span>(<span class="ruby-identifier">new_status</span>)
  <span class="ruby-keyword">if</span> (<span class="ruby-keyword">self</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">new_status</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">repo</span>.<span class="ruby-identifier">get_head</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">branch</span>).<span class="ruby-identifier">nil?</span>)
    <span class="ruby-identifier">old_branch_leaf</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">branch</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">'/'</span>).<span class="ruby-identifier">last</span>
    <span class="ruby-identifier">new_branch_components</span> = [<span class="ruby-identifier">old_branch_leaf</span>]
    
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">new_status</span> <span class="ruby-operator">==</span> <span class="ruby-string">'editing'</span>
      <span class="ruby-identifier">new_branch_components</span>.<span class="ruby-identifier">unshift</span>(<span class="ruby-identifier">new_status</span>, <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%Y/%m/%d&quot;</span>))
    <span class="ruby-keyword">end</span>
    
    <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">parent</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-keyword">self</span>.<span class="ruby-identifier">parent</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Board</span>)
      <span class="ruby-identifier">new_branch_components</span>.<span class="ruby-identifier">unshift</span>(<span class="ruby-identifier">title_to_ref</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">parent</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">title</span>))
    <span class="ruby-keyword">end</span>
    
    <span class="ruby-identifier">new_branch_name</span> = <span class="ruby-identifier">new_branch_components</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">'/'</span>)

    <span class="ruby-comment"># prevent collisions</span>
    <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">branches</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">new_branch_name</span>)
      <span class="ruby-identifier">new_branch_name</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;-%H.%M.%S&quot;</span>)
    <span class="ruby-keyword">end</span>
  
    <span class="ruby-comment"># branch from the original branch</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">create_branch</span>(<span class="ruby-identifier">new_branch_name</span>,
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">repo</span>.<span class="ruby-identifier">get_head</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">branch</span>).<span class="ruby-identifier">commit</span>.<span class="ruby-identifier">sha</span>)
    <span class="ruby-comment"># delete the original branch</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">delete_branch</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">branch</span>)
    <span class="ruby-comment"># set to new branch</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">branch</span> = <span class="ruby-identifier">new_branch_name</span>
    <span class="ruby-comment"># set status to new status</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">status</span> = <span class="ruby-identifier">new_status</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">save!</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- change_status-source -->
          
        </div>

        

        
      </div><!-- change_status-method -->

    
      <div id="method-i-children_votes" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">children_votes</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>total votes for the publication children in voting status</p>
          

          
          <div class="method-source-code" id="children_votes-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 1269</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">children_votes</span>
  <span class="ruby-identifier">vote_total</span> = <span class="ruby-value">0</span>
  <span class="ruby-identifier">vote_ddb</span> = <span class="ruby-value">0</span>
  <span class="ruby-identifier">vote_meta</span> = <span class="ruby-value">0</span>
  <span class="ruby-identifier">vote_trans</span> = <span class="ruby-value">0</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">children</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span><span class="ruby-operator">|</span><span class="ruby-identifier">x</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">x</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">==</span> <span class="ruby-string">'voting'</span>
      <span class="ruby-identifier">x</span>.<span class="ruby-identifier">identifiers</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">y</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">case</span> <span class="ruby-identifier">y</span>
          <span class="ruby-keyword">when</span> <span class="ruby-constant">DDBIdentifier</span>
            <span class="ruby-identifier">vote_ddb</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">y</span>.<span class="ruby-identifier">votes</span>.<span class="ruby-identifier">length</span>
            <span class="ruby-identifier">vote_total</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">vote_ddb</span>
          <span class="ruby-keyword">when</span> <span class="ruby-constant">HGVMetaIdentifier</span>
            <span class="ruby-identifier">vote_meta</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">y</span>.<span class="ruby-identifier">votes</span>.<span class="ruby-identifier">length</span>
            <span class="ruby-identifier">vote_total</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">vote_meta</span>
          <span class="ruby-keyword">when</span> <span class="ruby-constant">HGVTransIdentifier</span>
            <span class="ruby-identifier">vote_trans</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">y</span>.<span class="ruby-identifier">votes</span>.<span class="ruby-identifier">length</span>
            <span class="ruby-identifier">vote_total</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">vote_trans</span>
        <span class="ruby-keyword">end</span> <span class="ruby-comment">#case</span>
      <span class="ruby-keyword">end</span> <span class="ruby-comment"># identifiers do</span>
    <span class="ruby-keyword">end</span> <span class="ruby-comment">#if</span>
  <span class="ruby-keyword">end</span> <span class="ruby-comment">#children do</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">vote_total</span>, <span class="ruby-identifier">vote_ddb</span>, <span class="ruby-identifier">vote_meta</span>, <span class="ruby-identifier">vote_trans</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- children_votes-source -->
          
        </div>

        

        
      </div><!-- children_votes-method -->

    
      <div id="method-i-clone_to_end_user" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">clone_to_end_user</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Creates a new publication for the end_user (of a community) that is a
separate copy of this publication. This is similar to <a
href="Publication.html#method-i-clone_to_owner">#clone_to_owner</a>, except
the publication title is renamed to reflect the community and creator. The
new owner is the end_user for the publication’s community.</p>

<p><strong>Returns</strong> <code>publication</code> that is the new copy.</p>
          

          
          <div class="method-source-code" id="clone_to_end_user-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 1323</span>
 <span class="ruby-keyword">def</span> <span class="ruby-identifier">clone_to_end_user</span>()
  <span class="ruby-identifier">duplicate</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">clone</span>
  <span class="ruby-identifier">duplicate</span>.<span class="ruby-identifier">owner</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">community</span>.<span class="ruby-identifier">end_user</span>
  <span class="ruby-identifier">duplicate</span>.<span class="ruby-identifier">creator</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">community</span>.<span class="ruby-identifier">end_user</span> <span class="ruby-comment">#severing direct connection to orginal publication     self.creator</span>
  <span class="ruby-identifier">duplicate</span>.<span class="ruby-identifier">title</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">community</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot;/&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">creator</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot;/&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">title</span> <span class="ruby-comment">#adding orginal creator to title as reminder for end_user</span>
  <span class="ruby-identifier">duplicate</span>.<span class="ruby-identifier">branch</span> = <span class="ruby-identifier">title_to_ref</span>(<span class="ruby-identifier">duplicate</span>.<span class="ruby-identifier">title</span>)
  <span class="ruby-identifier">duplicate</span>.<span class="ruby-identifier">parent</span> = <span class="ruby-keyword">self</span>
  <span class="ruby-identifier">duplicate</span>.<span class="ruby-identifier">save!</span>
  
  <span class="ruby-comment"># copy identifiers over to new pub</span>
  <span class="ruby-identifier">identifiers</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">identifier</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">duplicate_identifier</span> = <span class="ruby-identifier">identifier</span>.<span class="ruby-identifier">clone</span>
    <span class="ruby-identifier">duplicate</span>.<span class="ruby-identifier">identifiers</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">duplicate_identifier</span>
  <span class="ruby-keyword">end</span>
  
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">duplicate</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- clone_to_end_user-source -->
          
        </div>

        

        
      </div><!-- clone_to_end_user-method -->

    
      <div id="method-i-clone_to_owner" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">clone_to_owner</span><span
            class="method-args">(new_owner)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Creates a new publication for the new_owner that is a separate copy of this
publication.</p>

<p><strong>Args</strong> <code>new_owner</code> the owner for the cloned copy.</p>

<p><strong>Returns</strong> <code>publication</code> that is the new copy.</p>
          

          
          <div class="method-source-code" id="clone_to_owner-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 1299</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">clone_to_owner</span>(<span class="ruby-identifier">new_owner</span>)
  <span class="ruby-identifier">duplicate</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">clone</span>
  <span class="ruby-identifier">duplicate</span>.<span class="ruby-identifier">owner</span> = <span class="ruby-identifier">new_owner</span>
  <span class="ruby-identifier">duplicate</span>.<span class="ruby-identifier">creator</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">creator</span>
  <span class="ruby-identifier">duplicate</span>.<span class="ruby-identifier">title</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot;/&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">title</span>
  <span class="ruby-identifier">duplicate</span>.<span class="ruby-identifier">branch</span> = <span class="ruby-identifier">title_to_ref</span>(<span class="ruby-identifier">duplicate</span>.<span class="ruby-identifier">title</span>)
  <span class="ruby-identifier">duplicate</span>.<span class="ruby-identifier">parent</span> = <span class="ruby-keyword">self</span>
  <span class="ruby-identifier">duplicate</span>.<span class="ruby-identifier">save!</span>
  
  <span class="ruby-comment"># copy identifiers over to new pub</span>
  <span class="ruby-identifier">identifiers</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">identifier</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">duplicate_identifier</span> = <span class="ruby-identifier">identifier</span>.<span class="ruby-identifier">clone</span>
    <span class="ruby-identifier">duplicate</span>.<span class="ruby-identifier">identifiers</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">duplicate_identifier</span>
  <span class="ruby-keyword">end</span>
  
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">duplicate</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- clone_to_owner-source -->
          
        </div>

        

        
      </div><!-- clone_to_owner-method -->

    
      <div id="method-i-commit_to_canon" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">commit_to_canon</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="commit_to_canon-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 1013</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">commit_to_canon</span>
  <span class="ruby-comment">#commit_sha is just used to return git sha reference point for comment</span>
  <span class="ruby-identifier">commit_sha</span> = <span class="ruby-keyword">nil</span>

  <span class="ruby-identifier">canon</span> = <span class="ruby-constant">Repository</span>.<span class="ruby-identifier">new</span>
  <span class="ruby-identifier">publication_sha</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">head</span>
  <span class="ruby-identifier">canonical_sha</span> = <span class="ruby-identifier">canon</span>.<span class="ruby-identifier">repo</span>.<span class="ruby-identifier">get_head</span>(<span class="ruby-string">'master'</span>).<span class="ruby-identifier">commit</span>.<span class="ruby-identifier">sha</span>
  
  <span class="ruby-comment"># FIXME: This walks the whole rev list, should maybe use git merge-base</span>
  <span class="ruby-comment"># to find the branch point? Though that may do the same internally...</span>
  <span class="ruby-comment"># commits = canon.repo.commit_deltas_from(self.owner.repository.repo, 'master', self.branch)</span>
  
  <span class="ruby-comment"># Commits that are in canonical master but not this branch</span>
  <span class="ruby-comment"># Forcing method_missing here to directly call rev-list is much faster</span>
  <span class="ruby-identifier">commits</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">repo</span>.<span class="ruby-identifier">git</span>.<span class="ruby-identifier">method_missing</span>(<span class="ruby-string">'rev-list'</span>,{}, <span class="ruby-identifier">canonical_sha</span>, <span class="ruby-node">&quot;^#{publication_sha}&quot;</span>).<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;\n&quot;</span>)
  
  <span class="ruby-comment"># canon.repo.git.merge({:no_commit =&gt; true, :stat =&gt; true},</span>
    <span class="ruby-comment"># self.owner.repository.repo.get_head(self.branch).commit.sha)</span>
  
  <span class="ruby-comment"># get the result of merging canon master into this branch</span>
  <span class="ruby-comment"># merge = Grit::Merge.new(</span>
  <span class="ruby-comment">#   self.owner.repository.repo.git.merge_tree({},</span>
  <span class="ruby-comment">#     publication_sha, canonical_sha, publication_sha))</span>
  
  
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">canon_controlled_identifiers</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">commits</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
      <span class="ruby-comment"># nothing new from canon, trivial merge by updating HEAD </span>
      <span class="ruby-comment"># e.g. &quot;Fast-forward&quot; merge, HEAD is already contained in the commit</span>
      <span class="ruby-comment"># canon.fetch_objects(self.owner.repository)</span>
      <span class="ruby-identifier">canon</span>.<span class="ruby-identifier">add_alternates</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">repository</span>)
      <span class="ruby-identifier">commit_sha</span> = <span class="ruby-identifier">canon</span>.<span class="ruby-identifier">repo</span>.<span class="ruby-identifier">update_ref</span>(<span class="ruby-string">'master'</span>, <span class="ruby-identifier">publication_sha</span>)
      
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">change_status</span>(<span class="ruby-string">'committed'</span>)
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">save!</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-comment"># Both the merged commit and HEAD are independent and must be tied </span>
      <span class="ruby-comment"># together by a merge commit that has both of them as its parents.</span>
    
      <span class="ruby-comment"># TODO: DRY from flatten_commits</span>
      <span class="ruby-identifier">controlled_blobs</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">canon_controlled_paths</span>.<span class="ruby-identifier">collect</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">controlled_path</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">get_blob_from_branch</span>(<span class="ruby-identifier">controlled_path</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">branch</span>)
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">controlled_paths_blobs</span> = 
        <span class="ruby-constant">Hash</span>[*((<span class="ruby-keyword">self</span>.<span class="ruby-identifier">canon_controlled_paths</span>.<span class="ruby-identifier">zip</span>(<span class="ruby-identifier">controlled_blobs</span>)).<span class="ruby-identifier">flatten</span>)]

      <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span>(<span class="ruby-node">&quot;Controlled Blobs: #{controlled_blobs.inspect}&quot;</span>)
      <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span>(<span class="ruby-node">&quot;Controlled Paths =&gt; Blobs: #{controlled_paths_blobs.inspect}&quot;</span>)
    
      <span class="ruby-comment"># roll a tree SHA1 by reading the canonical master tree,</span>
      <span class="ruby-comment"># adding controlled path blobs, then writing the modified tree</span>
      <span class="ruby-comment"># (happens on the finalizer's repo)</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">update_master_from_canonical</span>
      <span class="ruby-identifier">index</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">repo</span>.<span class="ruby-identifier">index</span>
      <span class="ruby-identifier">index</span>.<span class="ruby-identifier">read_tree</span>(<span class="ruby-string">'master'</span>)
      <span class="ruby-identifier">controlled_paths_blobs</span>.<span class="ruby-identifier">each_pair</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">path</span>, <span class="ruby-identifier">blob</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">index</span>.<span class="ruby-identifier">add</span>(<span class="ruby-identifier">path</span>, <span class="ruby-identifier">blob</span>.<span class="ruby-identifier">data</span>)
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">tree_sha1</span> = <span class="ruby-identifier">index</span>.<span class="ruby-identifier">write_tree</span>(<span class="ruby-identifier">index</span>.<span class="ruby-identifier">tree</span>, <span class="ruby-identifier">index</span>.<span class="ruby-identifier">current_tree</span>)
      <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span>(<span class="ruby-node">&quot;Wrote tree as SHA1: #{tree_sha1}&quot;</span>)

      <span class="ruby-identifier">commit_message</span> = <span class="ruby-node">&quot;Finalization merge of branch '#{self.branch}' into canonical master&quot;</span>
    
      <span class="ruby-identifier">contents</span> = []
      <span class="ruby-identifier">contents</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-string">'tree'</span>, <span class="ruby-identifier">tree_sha1</span>].<span class="ruby-identifier">join</span>(<span class="ruby-string">' '</span>)
      <span class="ruby-identifier">contents</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-string">'parent'</span>, <span class="ruby-identifier">canonical_sha</span>].<span class="ruby-identifier">join</span>(<span class="ruby-string">' '</span>)
      <span class="ruby-identifier">contents</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-string">'parent'</span>, <span class="ruby-identifier">publication_sha</span>].<span class="ruby-identifier">join</span>(<span class="ruby-string">' '</span>)

      <span class="ruby-identifier">contents</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-string">'author'</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">git_author_string</span>].<span class="ruby-identifier">join</span>(<span class="ruby-string">' '</span>)
      <span class="ruby-identifier">contents</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-string">'committer'</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">git_author_string</span>].<span class="ruby-identifier">join</span>(<span class="ruby-string">' '</span>)
      <span class="ruby-identifier">contents</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">''</span>
      <span class="ruby-identifier">contents</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">commit_message</span>
    
      <span class="ruby-identifier">finalized_commit_sha1</span> = 
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">repo</span>.<span class="ruby-identifier">git</span>.<span class="ruby-identifier">put_raw_object</span>(
          <span class="ruby-identifier">contents</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;\n&quot;</span>), <span class="ruby-string">'commit'</span>)
    
      <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span>(<span class="ruby-node">&quot;Finalized commit contents:\n#{contents.join(&quot;\n&quot;)}&quot;</span>)
      <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span>(<span class="ruby-node">&quot;Wrote finalized commit merge as SHA1: #{finalized_commit_sha1}&quot;</span>)
    
      <span class="ruby-comment"># Update our own head first</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">repo</span>.<span class="ruby-identifier">update_ref</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">branch</span>, <span class="ruby-identifier">finalized_commit_sha1</span>)
    
      <span class="ruby-comment"># canon.fetch_objects(self.owner.repository)</span>
      <span class="ruby-identifier">canon</span>.<span class="ruby-identifier">add_alternates</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">repository</span>)
      <span class="ruby-identifier">commit_sha</span> = <span class="ruby-identifier">canon</span>.<span class="ruby-identifier">repo</span>.<span class="ruby-identifier">update_ref</span>(<span class="ruby-string">'master'</span>, <span class="ruby-identifier">finalized_commit_sha1</span>)
      
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">change_status</span>(<span class="ruby-string">'committed'</span>)
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">save!</span>
    <span class="ruby-keyword">end</span>
    
    <span class="ruby-comment"># finalized, try to repack</span>
    <span class="ruby-keyword">begin</span>
      <span class="ruby-identifier">canon</span>.<span class="ruby-identifier">repo</span>.<span class="ruby-identifier">git</span>.<span class="ruby-identifier">repack</span>({})
    <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Grit</span><span class="ruby-operator">::</span><span class="ruby-constant">Git</span><span class="ruby-operator">::</span><span class="ruby-constant">GitTimeout</span>
      <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">warn</span>(<span class="ruby-string">&quot;Canonical repository not repacked after finalization!&quot;</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-comment"># nothing under canon control, just say it's committed</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">change_status</span>(<span class="ruby-string">'committed'</span>)
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">save!</span>
    
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">commit_sha</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- commit_to_canon-source -->
          
        </div>

        

        
      </div><!-- commit_to_canon-method -->

    
      <div id="method-i-controlled_identifiers" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">controlled_identifiers</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Determines which identifiers are controlled by this publication’s board.
<strong>Returns</strong></p>
<ul><li>
<p>array of identifiers from this publication that are controlled by this
publication’s board</p>
</li><li>
<p>empty array if this publication is not owned by a board or a finalizer</p>
</li></ul>
          

          
          <div class="method-source-code" id="controlled_identifiers-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 1131</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">controlled_identifiers</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">identifiers</span>.<span class="ruby-identifier">select</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Board</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">identifier_classes</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">i</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">to_s</span>)
    <span class="ruby-keyword">elsif</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">==</span> <span class="ruby-string">'finalizing'</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">parent</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">identifier_classes</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">i</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">to_s</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- controlled_identifiers-source -->
          
        </div>

        

        
      </div><!-- controlled_identifiers-method -->

    
      <div id="method-i-controlled_paths" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">controlled_paths</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Determines paths for identifiers that are controlled by this
publication’s board. <strong>Returns</strong></p>
<ul><li>
<p>array of paths from this publication that are controlled by this
publication’s board</p>
</li><li>
<p>empty array if this publication is not owned by a board or a finalizer</p>
</li></ul>
          

          
          <div class="method-source-code" id="controlled_paths-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 1149</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">controlled_paths</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">controlled_identifiers</span>.<span class="ruby-identifier">collect</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">i</span>.<span class="ruby-identifier">to_path</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- controlled_paths-source -->
          
        </div>

        

        
      </div><!-- controlled_paths-method -->

    
      <div id="method-i-copy_back_to_user" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">copy_back_to_user</span><span
            class="method-args">(commit_comment, committer_user)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Copies changes made to this publication back to the creator’s (origin)
publication. Preserves commit history for changes. This is intended to be
called from the finalizer’s publication copy.</p>

<p><strong>Args</strong></p>
<ul><li>
<p><code>commit_comment</code> comment object for commit</p>
</li><li>
<p><code>committer_user</code> the user who is making the commit</p>
</li></ul>
          

          
          <div class="method-source-code" id="copy_back_to_user-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 930</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">copy_back_to_user</span>(<span class="ruby-identifier">commit_comment</span>, <span class="ruby-identifier">committer_user</span>)
       <span class="ruby-comment">#copies changes made to this (self) publication back to the creator's publication</span>
       <span class="ruby-comment">#this is intended to be called from the finalizer's publication copy</span>
<span class="ruby-comment">      Rails.logger.info &quot;==========COMMUNITY PUBLICATION==========&quot;
      Rails.logger.info &quot;----Community is &quot; + self.community.name
      Rails.logger.info &quot;----Board is &quot; + self.find_first_board.name
      Rails.logger.info &quot;====creators publication begining finalize==&quot;
      @publication.origin.log_info
</span>        
      <span class="ruby-comment">#determine where to get data to build the index, </span>
      <span class="ruby-comment"># controlled paths are from the finalizer (this) publication</span>
      <span class="ruby-comment"># uncontrolled paths are from the origin publication</span>
   
      <span class="ruby-identifier">controlled_paths</span> =  <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">controlled_paths</span>)
      <span class="ruby-comment">#get the controlled blobs from the local branch (the finalizer's)</span>
      <span class="ruby-comment">#controlled_blobs are the files that the board controls and have changed</span>
      <span class="ruby-identifier">controlled_blobs</span> = <span class="ruby-identifier">controlled_paths</span>.<span class="ruby-identifier">collect</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">controlled_path</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">get_blob_from_branch</span>(<span class="ruby-identifier">controlled_path</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">branch</span>)
      <span class="ruby-keyword">end</span>
      <span class="ruby-comment">#combine controlled paths and blobs into a hash  </span>
      <span class="ruby-identifier">controlled_paths_blobs</span> = <span class="ruby-constant">Hash</span>[*((<span class="ruby-identifier">controlled_paths</span>.<span class="ruby-identifier">zip</span>(<span class="ruby-identifier">controlled_blobs</span>)).<span class="ruby-identifier">flatten</span>)]
      
      <span class="ruby-comment">#determine existing uncontrolled paths &amp; blobs</span>
      <span class="ruby-comment">#uncontrolled are taken from the origin, they have not been changed by board</span>
      <span class="ruby-identifier">origin_identifier_paths</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">origin</span>.<span class="ruby-identifier">identifiers</span>.<span class="ruby-identifier">collect</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">i</span>.<span class="ruby-identifier">to_path</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">uncontrolled_paths</span> = <span class="ruby-identifier">origin_identifier_paths</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">controlled_paths</span>
      <span class="ruby-identifier">uncontrolled_blobs</span> = <span class="ruby-identifier">uncontrolled_paths</span>.<span class="ruby-identifier">collect</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ucp</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">origin</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">get_blob_from_branch</span>(<span class="ruby-identifier">ucp</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">origin</span>.<span class="ruby-identifier">branch</span>)
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">uncontrolled_paths_blobs</span> = <span class="ruby-constant">Hash</span>[*((<span class="ruby-identifier">uncontrolled_paths</span>.<span class="ruby-identifier">zip</span>(<span class="ruby-identifier">uncontrolled_blobs</span>)).<span class="ruby-identifier">flatten</span>)]
        
     
<span class="ruby-comment">      Rails.logger.info &quot;----Controlled paths for community publication are:&quot; + controlled_paths.inspect      
      Rails.logger.info &quot;--uncontrolled paths: &quot;  + uncontrolled_paths.inspect
    
      Rails.logger.info &quot;-----Uncontrolled Blobs are:&quot;
      uncontrolled_blobs.each do |cb|
        Rails.logger.info &quot;-&quot; + cb.to_s
      end            
      Rails.logger.info &quot;-----Controlled Blobs are:&quot;
      controlled_blobs.each do |cb|
        Rails.logger.info &quot;-&quot; + cb.to_s
      end
</span>
      <span class="ruby-comment">#goal is to copy final blobs back to user's original publication (and preserve other blobs in original publication)</span>
      <span class="ruby-identifier">origin_index</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">origin</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">repo</span>.<span class="ruby-identifier">index</span>
      <span class="ruby-identifier">origin_index</span>.<span class="ruby-identifier">read_tree</span>(<span class="ruby-string">'master'</span>)
      
      <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-string">&quot;=======orign INDEX before add========&quot;</span>
      <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-identifier">origin_index</span>.<span class="ruby-identifier">inspect</span>
      
      
      <span class="ruby-comment">#add the controlled paths to the index</span>
      <span class="ruby-identifier">controlled_paths_blobs</span>.<span class="ruby-identifier">each_pair</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">path</span>, <span class="ruby-identifier">blob</span><span class="ruby-operator">|</span>
         <span class="ruby-identifier">origin_index</span>.<span class="ruby-identifier">add</span>(<span class="ruby-identifier">path</span>, <span class="ruby-identifier">blob</span>.<span class="ruby-identifier">data</span>)
         <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-string">&quot;--Adding controlled path blob: &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">path</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot; &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">blob</span>.<span class="ruby-identifier">data</span>
      <span class="ruby-keyword">end</span>
      
      <span class="ruby-comment">#need to add exiting tree to index, except for controlled blobs</span>
      <span class="ruby-identifier">uncontrolled_paths_blobs</span>.<span class="ruby-identifier">each_pair</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">path</span>, <span class="ruby-identifier">blob</span><span class="ruby-operator">|</span>
          <span class="ruby-identifier">origin_index</span>.<span class="ruby-identifier">add</span>(<span class="ruby-identifier">path</span>, <span class="ruby-identifier">blob</span>.<span class="ruby-identifier">data</span>)
          <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-string">&quot;--Adding uncontrolled path blob: &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">path</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot; &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">blob</span>.<span class="ruby-identifier">data</span>
      <span class="ruby-keyword">end</span>
      

      <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-string">&quot;=======orign INDEX after add========&quot;</span>
      <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-identifier">origin_index</span>.<span class="ruby-identifier">inspect</span>
 
     <span class="ruby-comment">#origin_index.commit(params[:comment],  @publication.origin.head, @current_user , nil, @publication.origin.branch)</span>
      <span class="ruby-identifier">origin_index</span>.<span class="ruby-identifier">commit</span>(<span class="ruby-identifier">commit_comment</span>,  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">origin</span>.<span class="ruby-identifier">head</span>, <span class="ruby-identifier">committer_user</span> , <span class="ruby-keyword">nil</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">origin</span>.<span class="ruby-identifier">branch</span>)
     
     <span class="ruby-comment">#Rails.logger.info origin_index.commit(&quot;comment&quot;,  @publication.origin.head, nil, nil, @publication.origin.branch)</span>

      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">origin</span>.<span class="ruby-identifier">save</span> 
  <span class="ruby-keyword">end</span></pre>
          </div><!-- copy_back_to_user-source -->
          
        </div>

        

        
      </div><!-- copy_back_to_user-method -->

    
      <div id="method-i-copy_repo_to_parent_repo" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">copy_repo_to_parent_repo</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>copy a child publication repo back to the parent repo</p>
          

          
          <div class="method-source-code" id="copy_repo_to_parent_repo-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 1368</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">copy_repo_to_parent_repo</span>
   <span class="ruby-comment">#all we need to do is copy the repo back the parents repo</span>
   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">origin</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">copy_branch_from_repo</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">branch</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">origin</span>.<span class="ruby-identifier">branch</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">repository</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- copy_repo_to_parent_repo-source -->
          
        </div>

        

        
      </div><!-- copy_repo_to_parent_repo-method -->

    
      <div id="method-i-copy_to_end_user" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">copy_to_end_user</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>mainly used to create new publiation title/repo name that is indicative of
the publications source</p>
          

          
          <div class="method-source-code" id="copy_to_end_user-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 1359</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">copy_to_end_user</span>()
  <span class="ruby-identifier">duplicate</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">clone_to_end_user</span>()
  <span class="ruby-identifier">duplicate</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">copy_branch_from_repo</span>(
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">branch</span>, <span class="ruby-identifier">duplicate</span>.<span class="ruby-identifier">branch</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">repository</span>
  )
  
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">duplicate</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- copy_to_end_user-source -->
          
        </div>

        

        
      </div><!-- copy_to_end_user-method -->

    
      <div id="method-i-copy_to_owner" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">copy_to_owner</span><span
            class="method-args">(new_owner)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>copies this publication’s branch to the new_owner’s branch returns
duplicate publication with new_owner</p>
          

          
          <div class="method-source-code" id="copy_to_owner-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 1347</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">copy_to_owner</span>(<span class="ruby-identifier">new_owner</span>)
  <span class="ruby-identifier">duplicate</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">clone_to_owner</span>(<span class="ruby-identifier">new_owner</span>)
  
  <span class="ruby-identifier">duplicate</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">copy_branch_from_repo</span>(
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">branch</span>, <span class="ruby-identifier">duplicate</span>.<span class="ruby-identifier">branch</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">repository</span>
  )
  
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">duplicate</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- copy_to_owner-source -->
          
        </div>

        

        
      </div><!-- copy_to_owner-method -->

    
      <div id="method-i-creatable_identifiers" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">creatable_identifiers</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="creatable_identifiers-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 1466</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">creatable_identifiers</span>
  <span class="ruby-identifier">creatable_identifiers</span> = <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">Identifier</span><span class="ruby-operator">::</span><span class="ruby-constant">IDENTIFIER_SUBCLASSES</span>)
  
  <span class="ruby-comment">#WARNING hardcoded identifier depenency hack  </span>
  <span class="ruby-comment">#enforce creation order</span>
  <span class="ruby-identifier">has_meta</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-identifier">has_text</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-identifier">has_biblio</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">identifiers</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;BiblioIdentifier&quot;</span>
      <span class="ruby-identifier">has_biblio</span> = <span class="ruby-keyword">true</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;HGVMetaIdentifier&quot;</span>
      <span class="ruby-identifier">has_meta</span> = <span class="ruby-keyword">true</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;DDBIdentifier&quot;</span>
     <span class="ruby-identifier">has_text</span> = <span class="ruby-keyword">true</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">has_text</span>
    <span class="ruby-comment">#cant create trans</span>
    <span class="ruby-identifier">creatable_identifiers</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-string">&quot;HGVTransIdentifier&quot;</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">has_meta</span>
    <span class="ruby-comment">#cant create text</span>
    <span class="ruby-identifier">creatable_identifiers</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-string">&quot;DDBIdentifier&quot;</span>)
    <span class="ruby-comment">#cant create trans</span>
    <span class="ruby-identifier">creatable_identifiers</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-string">&quot;HGVTransIdentifier&quot;</span>)     
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">creatable_identifiers</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-string">&quot;BiblioIdentifier&quot;</span>)
  <span class="ruby-comment"># Not allowed to create any other record in association with a BiblioIdentifier publication</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">has_biblio</span>
    <span class="ruby-identifier">creatable_identifiers</span> = []
  <span class="ruby-keyword">end</span>
  
  <span class="ruby-comment">#only let user create new for non-existing        </span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">identifiers</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">creatable_identifiers</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">ci</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">ci</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">to_s</span>
        <span class="ruby-identifier">creatable_identifiers</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">ci</span>)    
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>  

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">creatable_identifiers</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- creatable_identifiers-source -->
          
        </div>

        

        
      </div><!-- creatable_identifiers-method -->

    
      <div id="method-i-diff_from_canon" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">diff_from_canon</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="diff_from_canon-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 1166</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">diff_from_canon</span>
  <span class="ruby-identifier">canon</span> = <span class="ruby-constant">Repository</span>.<span class="ruby-identifier">new</span>
  <span class="ruby-identifier">canonical_sha</span> = <span class="ruby-identifier">canon</span>.<span class="ruby-identifier">repo</span>.<span class="ruby-identifier">get_head</span>(<span class="ruby-string">'master'</span>).<span class="ruby-identifier">commit</span>.<span class="ruby-identifier">sha</span>
  <span class="ruby-identifier">diff</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">repo</span>.<span class="ruby-identifier">git</span>.<span class="ruby-identifier">diff</span>(
    {<span class="ruby-value">:unified</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">5000</span>}, <span class="ruby-identifier">canonical_sha</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">head</span>,
    <span class="ruby-string">'--'</span>, *(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">controlled_paths</span>))
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">diff</span> <span class="ruby-operator">||</span> <span class="ruby-string">&quot;&quot;</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- diff_from_canon-source -->
          
        </div>

        

        
      </div><!-- diff_from_canon-method -->

    
      <div id="method-i-entry_identifier" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">entry_identifier</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>entry point identifier to use when we’re just coming in from a
publication</p>
          

          
          <div class="method-source-code" id="entry_identifier-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 1376</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">entry_identifier</span>
  <span class="ruby-identifier">identifiers</span>.<span class="ruby-identifier">first</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- entry_identifier-source -->
          
        </div>

        

        
      </div><!-- entry_identifier-method -->

    
      <div id="method-i-find_finalizer_publication" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">find_finalizer_publication</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p><strong>Returns</strong> the finalizer’s <code>publication</code> or
<code>nil</code> if there is no finalizer.</p>
          

          
          <div class="method-source-code" id="find_finalizer_publication-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 910</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">find_finalizer_publication</span>
<span class="ruby-comment">#returns the finalizer's publication or nil if finalizer does not exist</span>
  <span class="ruby-constant">Publication</span>.<span class="ruby-identifier">find_by_parent_id</span>( <span class="ruby-keyword">self</span>.<span class="ruby-identifier">id</span>, <span class="ruby-value">:conditions</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-value">:status</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;finalizing&quot;</span> })
<span class="ruby-keyword">end</span></pre>
          </div><!-- find_finalizer_publication-source -->
          
        </div>

        

        
      </div><!-- find_finalizer_publication-method -->

    
      <div id="method-i-find_finalizer_user" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">find_finalizer_user</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p><strong>Returns</strong> the <code>user</code> who is finalizing this
publication or <code>nil</code> if no one finalizing this publication.</p>
          

          
          <div class="method-source-code" id="find_finalizer_user-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 902</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">find_finalizer_user</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">find_finalizer_publication</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">find_finalizer_publication</span>.<span class="ruby-identifier">owner</span>    
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- find_finalizer_user-source -->
          
        </div>

        

        
      </div><!-- find_finalizer_user-method -->

    
      <div id="method-i-find_first_board" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">find_first_board</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Finds the closest parent(or self) publication whose owner is a board.
Returns that board.</p>

<p><strong>Returns</strong></p>
<ul><li>
<p><code>board</code> that owns the publication.</p>
</li><li>
<p><code>nil</code> if no board owned publication found.</p>
</li></ul>
          

          
          <div class="method-source-code" id="find_first_board-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 1242</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">find_first_board</span>
  <span class="ruby-identifier">board_publication</span> = <span class="ruby-keyword">self</span>
  <span class="ruby-keyword">while</span> (<span class="ruby-identifier">board_publication</span>.<span class="ruby-identifier">owner_type</span> <span class="ruby-operator">!=</span> <span class="ruby-string">&quot;Board&quot;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">board_publication</span> <span class="ruby-operator">!=</span> <span class="ruby-keyword">nil</span>) <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">board_publication</span> = <span class="ruby-identifier">board_publication</span>.<span class="ruby-identifier">parent</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">board_publication</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">board_publication</span>.<span class="ruby-identifier">owner</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- find_first_board-source -->
          
        </div>

        

        
      </div><!-- find_first_board-method -->

    
      <div id="method-i-find_first_board_parent" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">find_first_board_parent</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Finds the closest parent(or self) publication whose owner is a board.
Returns that publication.</p>

<p><strong>Returns</strong></p>
<ul><li>
<p><code>publication</code> owned by the board.</p>
</li><li>
<p><code>nil</code> if no board owned publication found.</p>
</li></ul>
          

          
          <div class="method-source-code" id="find_first_board_parent-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 1260</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">find_first_board_parent</span>
  <span class="ruby-identifier">board_publication</span> = <span class="ruby-keyword">self</span>
  <span class="ruby-keyword">while</span> (<span class="ruby-identifier">board_publication</span>.<span class="ruby-identifier">owner_type</span> <span class="ruby-operator">!=</span> <span class="ruby-string">&quot;Board&quot;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">board_publication</span> <span class="ruby-operator">!=</span> <span class="ruby-keyword">nil</span>) <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">board_publication</span> = <span class="ruby-identifier">board_publication</span>.<span class="ruby-identifier">parent</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">board_publication</span>      
<span class="ruby-keyword">end</span></pre>
          </div><!-- find_first_board_parent-source -->
          
        </div>

        

        
      </div><!-- find_first_board_parent-method -->

    
      <div id="method-i-flatten_commits" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">flatten_commits</span><span
            class="method-args">(finalizing_publication, finalizer, board_members)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="flatten_commits-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 695</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">flatten_commits</span>(<span class="ruby-identifier">finalizing_publication</span>, <span class="ruby-identifier">finalizer</span>, <span class="ruby-identifier">board_members</span>)
  <span class="ruby-identifier">finalizing_publication</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">fetch_objects</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">repository</span>)
  
  <span class="ruby-comment"># flatten commits by original publication creator</span>
  <span class="ruby-comment"># - use the submission reason as the main comment</span>
  <span class="ruby-comment"># - concatenate all non-empty commit messages into a list</span>
  <span class="ruby-comment"># - write a 'Signed-off-by:' line for each Ed. Board member</span>
  <span class="ruby-comment"># - rewrite the committer to the finalizer</span>
  <span class="ruby-comment"># - parent will be the branch point from canon (merge-base)</span>
  <span class="ruby-comment"># - tree will be from creator's last commit</span>
  <span class="ruby-comment"># - see http://idp.atlantides.org/trac/idp/wiki/SoSOL/Attribution</span>
  <span class="ruby-comment"># X insert a change in the XML revisionDesc header</span>
  <span class="ruby-comment">#   should instead happen at submit so EB sees it?</span>
  
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">update_master_from_canonical</span>
  <span class="ruby-identifier">canon_branch_point</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">merge_base</span>
  
  <span class="ruby-comment"># this relies on the parent being a remote, e.g. fetch_objects being used</span>
  <span class="ruby-comment"># during branch copy</span>
  <span class="ruby-comment"># board_branch_point = self.merge_base(</span>
  <span class="ruby-comment">#   [self.parent.repository.name, self.parent.branch].join('/'))</span>
  <span class="ruby-comment"># this works regardless</span>
  <span class="ruby-identifier">board_branch_point</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">origin</span>.<span class="ruby-identifier">head</span>
  
  <span class="ruby-identifier">creator_commits</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">repo</span>.<span class="ruby-identifier">commits_between</span>(<span class="ruby-identifier">canon_branch_point</span>,
                                                         <span class="ruby-identifier">board_branch_point</span>)
  <span class="ruby-identifier">board_commits</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">repo</span>.<span class="ruby-identifier">commits_between</span>(<span class="ruby-identifier">board_branch_point</span>,
                                                       <span class="ruby-keyword">self</span>.<span class="ruby-identifier">head</span>)
  
  <span class="ruby-identifier">reason_comment</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">submission_reason</span>
  
  
  <span class="ruby-identifier">board_controlled_paths</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">controlled_paths</span>
  <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span>(<span class="ruby-node">&quot;Controlled Paths: #{board_controlled_paths.inspect}&quot;</span>)

  <span class="ruby-identifier">controlled_commits</span> = <span class="ruby-identifier">creator_commits</span>.<span class="ruby-identifier">select</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">creator_commit</span><span class="ruby-operator">|</span>
    <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span>(<span class="ruby-node">&quot;Checking Creator Commit id: #{creator_commit.id}&quot;</span>)
    <span class="ruby-identifier">controlled_commit_diffs</span> = <span class="ruby-constant">Grit</span><span class="ruby-operator">::</span><span class="ruby-constant">Commit</span>.<span class="ruby-identifier">diff</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">repo</span>, <span class="ruby-identifier">creator_commit</span>.<span class="ruby-identifier">parents</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">creator_commit</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">board_controlled_paths</span>.<span class="ruby-identifier">clone</span>)
    <span class="ruby-identifier">controlled_commit_diffs</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
  <span class="ruby-keyword">end</span>
  
  <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span>(<span class="ruby-node">&quot;Controlled Commits: #{controlled_commits.inspect}&quot;</span>)
  
  <span class="ruby-identifier">creator_commit_messages</span> = [<span class="ruby-identifier">reason_comment</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">?</span> <span class="ruby-string">''</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">reason_comment</span>.<span class="ruby-identifier">comment</span>, <span class="ruby-string">''</span>]
  <span class="ruby-identifier">controlled_commits</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">controlled_commit</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">message</span> = <span class="ruby-identifier">controlled_commit</span>.<span class="ruby-identifier">message</span>.<span class="ruby-identifier">strip</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">message</span>.<span class="ruby-identifier">empty?</span>
      <span class="ruby-identifier">creator_commit_messages</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot; - #{message}&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
  
  <span class="ruby-identifier">controlled_blobs</span> = <span class="ruby-identifier">board_controlled_paths</span>.<span class="ruby-identifier">collect</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">controlled_path</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">get_blob_from_branch</span>(<span class="ruby-identifier">controlled_path</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">branch</span>)
  <span class="ruby-keyword">end</span>
  
  <span class="ruby-identifier">controlled_paths_blobs</span> = 
    <span class="ruby-constant">Hash</span>[*((<span class="ruby-identifier">board_controlled_paths</span>.<span class="ruby-identifier">zip</span>(<span class="ruby-identifier">controlled_blobs</span>)).<span class="ruby-identifier">flatten</span>)]
  
  <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span>(<span class="ruby-node">&quot;Controlled Blobs: #{controlled_blobs.inspect}&quot;</span>)
  <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span>(<span class="ruby-node">&quot;Controlled Paths =&gt; Blobs: #{controlled_paths_blobs.inspect}&quot;</span>)
  
  <span class="ruby-identifier">signed_off_messages</span> = []
  <span class="ruby-identifier">board_members</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">board_member</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">signed_off_messages</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;Signed-off-by: #{board_member.author_string}&quot;</span>
  <span class="ruby-keyword">end</span>
  
  <span class="ruby-identifier">commit_message</span> =
    (<span class="ruby-identifier">creator_commit_messages</span> <span class="ruby-operator">+</span> [<span class="ruby-string">''</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">signed_off_messages</span>).<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;\n&quot;</span>).<span class="ruby-identifier">chomp</span>
  
  <span class="ruby-comment"># parent commit should ALWAYS be canonical master head</span>
  <span class="ruby-comment"># FIXME: handle racing during finalization</span>
  <span class="ruby-identifier">parent_commit</span> = <span class="ruby-constant">Repository</span>.<span class="ruby-identifier">new</span>.<span class="ruby-identifier">repo</span>.<span class="ruby-identifier">get_head</span>(<span class="ruby-string">'master'</span>).<span class="ruby-identifier">commit</span>.<span class="ruby-identifier">sha</span>
  <span class="ruby-comment"># parent_commit = canon_branch_point</span>
  
  <span class="ruby-comment"># roll a tree SHA1 by reading the canonical master tree,</span>
  <span class="ruby-comment"># adding controlled path blobs, then writing the modified tree</span>
  <span class="ruby-comment"># (happens on the finalizer's repo)</span>
  <span class="ruby-identifier">finalizer</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">update_master_from_canonical</span>
  <span class="ruby-identifier">index</span> = <span class="ruby-identifier">finalizer</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">repo</span>.<span class="ruby-identifier">index</span>
  <span class="ruby-identifier">index</span>.<span class="ruby-identifier">read_tree</span>(<span class="ruby-string">'master'</span>)
  <span class="ruby-identifier">controlled_paths_blobs</span>.<span class="ruby-identifier">each_pair</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">path</span>, <span class="ruby-identifier">blob</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">index</span>.<span class="ruby-identifier">add</span>(<span class="ruby-identifier">path</span>, <span class="ruby-identifier">blob</span>.<span class="ruby-identifier">data</span>)
  <span class="ruby-keyword">end</span>
  
  <span class="ruby-identifier">tree_sha1</span> = <span class="ruby-identifier">index</span>.<span class="ruby-identifier">write_tree</span>(<span class="ruby-identifier">index</span>.<span class="ruby-identifier">tree</span>, <span class="ruby-identifier">index</span>.<span class="ruby-identifier">current_tree</span>)
  <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span>(<span class="ruby-node">&quot;Wrote tree as SHA1: #{tree_sha1}&quot;</span>)
  <span class="ruby-comment"># tree_sha1 = self.repository.repo.commit(board_branch_point).tree.id</span>
  
  <span class="ruby-comment"># most of this is dup'd from Grit::Index#commit</span>
  <span class="ruby-comment"># with modifications to allow for correct timestamping</span>
  <span class="ruby-comment"># and author/committer split</span>
  <span class="ruby-identifier">contents</span> = []
  <span class="ruby-identifier">contents</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-string">'tree'</span>, <span class="ruby-identifier">tree_sha1</span>].<span class="ruby-identifier">join</span>(<span class="ruby-string">' '</span>)
  <span class="ruby-identifier">contents</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-string">'parent'</span>, <span class="ruby-identifier">parent_commit</span>].<span class="ruby-identifier">join</span>(<span class="ruby-string">' '</span>)
  
  <span class="ruby-identifier">contents</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-string">'author'</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">creator</span>.<span class="ruby-identifier">git_author_string</span>].<span class="ruby-identifier">join</span>(<span class="ruby-string">' '</span>)
  <span class="ruby-identifier">contents</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-string">'committer'</span>, <span class="ruby-identifier">finalizer</span>.<span class="ruby-identifier">git_author_string</span>].<span class="ruby-identifier">join</span>(<span class="ruby-string">' '</span>)
  <span class="ruby-identifier">contents</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">''</span>
  <span class="ruby-identifier">contents</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">commit_message</span>
  
  <span class="ruby-identifier">flattened_commit_sha1</span> = 
    <span class="ruby-identifier">finalizing_publication</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">repo</span>.<span class="ruby-identifier">git</span>.<span class="ruby-identifier">put_raw_object</span>(
      <span class="ruby-identifier">contents</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;\n&quot;</span>), <span class="ruby-string">'commit'</span>)
  
  <span class="ruby-identifier">finalizing_publication</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">create_branch</span>(
    <span class="ruby-identifier">finalizing_publication</span>.<span class="ruby-identifier">branch</span>, <span class="ruby-identifier">flattened_commit_sha1</span>)
  
  <span class="ruby-comment"># rewrite commits by EB</span>
  <span class="ruby-comment"># - write a 'Signed-off-by:' line for each Ed. Board member</span>
  <span class="ruby-comment"># - rewrite the committer to the finalizer</span>
  <span class="ruby-comment"># - change parent lineage to flattened commits</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- flatten_commits-source -->
          
        </div>

        

        
      </div><!-- flatten_commits-method -->

    
      <div id="method-i-get_all_comments" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_all_comments</span><span
            class="method-args">(title)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="get_all_comments-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 1380</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_all_comments</span>(<span class="ruby-identifier">title</span>)
  <span class="ruby-identifier">all_built_comments</span> = []
  <span class="ruby-identifier">xml_only_built_comments</span> = []
  <span class="ruby-comment"># select all comments associated with a publication title - will include from all users</span>
  <span class="ruby-ivar">@arcomments</span> = <span class="ruby-constant">Comment</span>.<span class="ruby-identifier">find_by_sql</span>(<span class="ruby-node">&quot;SELECT a.comment, a.user_id, a.identifier_id, a.reason, a.created_at 
                                       FROM comments a, publications b 
                                      WHERE b.title = '#{title}'
                                        AND a.publication_id = b.id
                                   ORDER BY a.created_at DESC&quot;</span>)
  <span class="ruby-comment"># add comments hash to array</span>
  <span class="ruby-ivar">@arcomments</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">built_comment</span> = <span class="ruby-constant">Comment</span><span class="ruby-operator">::</span><span class="ruby-constant">CombineComment</span>.<span class="ruby-identifier">new</span>
    
    <span class="ruby-identifier">built_comment</span>.<span class="ruby-identifier">xmltype</span> = <span class="ruby-string">&quot;model&quot;</span>
    
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">user</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">user</span>.<span class="ruby-identifier">name</span>
      <span class="ruby-identifier">built_comment</span>.<span class="ruby-identifier">who</span> = <span class="ruby-identifier">c</span>.<span class="ruby-identifier">user</span>.<span class="ruby-identifier">human_name</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">built_comment</span>.<span class="ruby-identifier">who</span> = <span class="ruby-string">&quot;user not filled in&quot;</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-comment"># convert date to local for consistency so work in sort below</span>
    <span class="ruby-identifier">built_comment</span>.<span class="ruby-identifier">when</span> = <span class="ruby-identifier">c</span>.<span class="ruby-identifier">created_at</span>.<span class="ruby-identifier">getlocal</span>
    
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">reason</span>
      <span class="ruby-identifier">built_comment</span>.<span class="ruby-identifier">why</span> = <span class="ruby-identifier">c</span>.<span class="ruby-identifier">reason</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">built_comment</span>.<span class="ruby-identifier">why</span> = <span class="ruby-string">&quot;reason not filled in&quot;</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-comment">#add identifier name if available</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">identifier</span>
      <span class="ruby-identifier">built_comment</span>.<span class="ruby-identifier">why</span> = <span class="ruby-identifier">built_comment</span>.<span class="ruby-identifier">why</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot; &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">identifier</span>.<span class="ruby-identifier">class</span><span class="ruby-operator">::</span><span class="ruby-constant">FRIENDLY_NAME</span>
    <span class="ruby-keyword">end</span>
    
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">comment</span>
      <span class="ruby-identifier">built_comment</span>.<span class="ruby-identifier">comment</span> = <span class="ruby-identifier">c</span>.<span class="ruby-identifier">comment</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">built_comment</span>.<span class="ruby-identifier">comment</span> = <span class="ruby-string">&quot;comment not filled in&quot;</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">all_built_comments</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">built_comment</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># add comments hash from each of the publication's identifiers XML file to array</span>
  <span class="ruby-identifier">identifiers</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">where_from</span> = <span class="ruby-identifier">i</span>.<span class="ruby-identifier">class</span><span class="ruby-operator">::</span><span class="ruby-constant">FRIENDLY_NAME</span>
    <span class="ruby-identifier">ident_title</span> = <span class="ruby-identifier">i</span>.<span class="ruby-identifier">title</span>
    
    <span class="ruby-identifier">ident_xml</span> = <span class="ruby-identifier">i</span>.<span class="ruby-identifier">xml_content</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">ident_xml</span>
      <span class="ruby-identifier">ident_xml_xpath</span> = <span class="ruby-constant">REXML</span><span class="ruby-operator">::</span><span class="ruby-constant">Document</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">ident_xml</span>)
      <span class="ruby-identifier">comment_path</span> = <span class="ruby-string">'/TEI/teiHeader/revisionDesc'</span>
      <span class="ruby-identifier">comment_here</span> = <span class="ruby-constant">REXML</span><span class="ruby-operator">::</span><span class="ruby-constant">XPath</span>.<span class="ruby-identifier">first</span>(<span class="ruby-identifier">ident_xml_xpath</span>, <span class="ruby-identifier">comment_path</span>)
     
      <span class="ruby-keyword">unless</span> <span class="ruby-identifier">comment_here</span>.<span class="ruby-identifier">nil?</span>
        <span class="ruby-identifier">comment_here</span>.<span class="ruby-identifier">each_element</span>(<span class="ruby-string">'//change'</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">change</span><span class="ruby-operator">|</span>
          <span class="ruby-identifier">built_comment</span> = <span class="ruby-constant">Comment</span><span class="ruby-operator">::</span><span class="ruby-constant">CombineComment</span>.<span class="ruby-identifier">new</span>
          
          <span class="ruby-identifier">built_comment</span>.<span class="ruby-identifier">xmltype</span> = <span class="ruby-identifier">where_from</span>
          
          <span class="ruby-keyword">if</span> <span class="ruby-identifier">change</span>.<span class="ruby-identifier">attributes</span>[<span class="ruby-string">&quot;who&quot;</span>]
            <span class="ruby-identifier">built_comment</span>.<span class="ruby-identifier">who</span> = <span class="ruby-identifier">change</span>.<span class="ruby-identifier">attributes</span>[<span class="ruby-string">&quot;who&quot;</span>]
          <span class="ruby-keyword">else</span>
            <span class="ruby-identifier">built_comment</span>.<span class="ruby-identifier">who</span> = <span class="ruby-string">&quot;no who attribute&quot;</span>
          <span class="ruby-keyword">end</span>
          
          <span class="ruby-comment"># parse will convert date to local for consistency so work in sort below</span>
          <span class="ruby-keyword">if</span> <span class="ruby-identifier">change</span>.<span class="ruby-identifier">attributes</span>[<span class="ruby-string">&quot;when&quot;</span>]
            <span class="ruby-identifier">built_comment</span>.<span class="ruby-identifier">when</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">change</span>.<span class="ruby-identifier">attributes</span>[<span class="ruby-string">&quot;when&quot;</span>])
          <span class="ruby-keyword">else</span>
            <span class="ruby-identifier">built_comment</span>.<span class="ruby-identifier">when</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-string">&quot;1988-8-8&quot;</span>)
          <span class="ruby-keyword">end</span>
          
          <span class="ruby-identifier">built_comment</span>.<span class="ruby-identifier">why</span> = <span class="ruby-string">&quot;From &quot;</span>  <span class="ruby-operator">+</span> <span class="ruby-identifier">ident_title</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot; &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">where_from</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot; XML&quot;</span>
          
          <span class="ruby-identifier">built_comment</span>.<span class="ruby-identifier">comment</span> = <span class="ruby-identifier">change</span>.<span class="ruby-identifier">text</span>
          
          <span class="ruby-identifier">all_built_comments</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">built_comment</span>
          <span class="ruby-identifier">xml_only_built_comments</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">built_comment</span>
        <span class="ruby-keyword">end</span> <span class="ruby-comment">#comment_here</span>
      <span class="ruby-keyword">end</span> <span class="ruby-comment">#comment_here.nil?</span>
    <span class="ruby-keyword">end</span> <span class="ruby-comment"># if ident_xml</span>
  <span class="ruby-keyword">end</span> <span class="ruby-comment">#identifiers each</span>
  <span class="ruby-comment"># sort in descending date order for display</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">all_built_comments</span>.<span class="ruby-identifier">sort_by</span>(&amp;<span class="ruby-value">:when</span>).<span class="ruby-identifier">reverse</span>, <span class="ruby-identifier">xml_only_built_comments</span>.<span class="ruby-identifier">sort_by</span>(&amp;<span class="ruby-value">:when</span>).<span class="ruby-identifier">reverse</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_all_comments-source -->
          
        </div>

        

        
      </div><!-- get_all_comments-method -->

    
      <div id="method-i-head" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">head</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="head-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 915</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">head</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">repo</span>.<span class="ruby-identifier">get_head</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">branch</span>).<span class="ruby-identifier">commit</span>.<span class="ruby-identifier">sha</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- head-source -->
          
        </div>

        

        
      </div><!-- head-method -->

    
      <div id="method-i-is_community_publication-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">is_community_publication?</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="is_community_publication-3F-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 347</span>
<span class="ruby-keyword">def</span>  <span class="ruby-identifier">is_community_publication?</span>
  <span class="ruby-keyword">return</span> (<span class="ruby-keyword">self</span>.<span class="ruby-identifier">community_id</span> <span class="ruby-operator">!=</span> <span class="ruby-keyword">nil</span>)  <span class="ruby-operator">&amp;&amp;</span>  (<span class="ruby-keyword">self</span>.<span class="ruby-identifier">community_id</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>)      
<span class="ruby-keyword">end</span></pre>
          </div><!-- is_community_publication-3F-source -->
          
        </div>

        

        
      </div><!-- is_community_publication-3F-method -->

    
      <div id="method-i-log_info" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">log_info</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Outputs publication information and content to the <a
href="Rails.html">Rails</a> logger.</p>
          

          
          <div class="method-source-code" id="log_info-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 189</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">log_info</span>
     <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-string">&quot;-----Publication Info-----&quot;</span>
     <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-string">&quot;--Owner: &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">name</span>
     <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-string">&quot;--Title: &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">title</span>
     <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-string">&quot;--Status: &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">status</span>
     <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-string">&quot;--content&quot;</span>
     
     <span class="ruby-keyword">self</span>.<span class="ruby-identifier">identifiers</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">id</span><span class="ruby-operator">|</span>
       <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-string">&quot;---ID title: &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">id</span>.<span class="ruby-identifier">title</span>
       <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-string">&quot;---ID class:&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">id</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">to_s</span>
       <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-string">&quot;---ID content:&quot;</span>
       <span class="ruby-keyword">if</span> <span class="ruby-identifier">id</span>.<span class="ruby-identifier">xml_content</span>
         <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-identifier">id</span>.<span class="ruby-identifier">xml_content</span>
       <span class="ruby-keyword">else</span>
         <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-string">&quot;NO CONTENT!&quot;</span>
       <span class="ruby-keyword">end</span>
       <span class="ruby-comment">#Rails.logger.info &quot;== end Owner: &quot; + publication.owner.name</span>
     <span class="ruby-keyword">end</span>
     <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-string">&quot;==end Owner: &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">name</span>
     <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-string">&quot;=====End Publication Info=====&quot;</span>
 <span class="ruby-keyword">end</span></pre>
          </div><!-- log_info-source -->
          
        </div>

        

        
      </div><!-- log_info-method -->

    
      <div id="method-i-merge_base" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">merge_base</span><span
            class="method-args">(branch = 'master')</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="merge_base-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 919</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">merge_base</span>(<span class="ruby-identifier">branch</span> = <span class="ruby-string">'master'</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">repo</span>.<span class="ruby-identifier">git</span>.<span class="ruby-identifier">merge_base</span>({},<span class="ruby-identifier">branch</span>,<span class="ruby-keyword">self</span>.<span class="ruby-identifier">head</span>).<span class="ruby-identifier">chomp</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- merge_base-source -->
          
        </div>

        

        
      </div><!-- merge_base-method -->

    
      <div id="method-i-modified-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">modified?</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p><strong>Returns</strong></p>
<ul><li>
<p><code>true</code> if any of the identifiers in the publication have been
modified.</p>
</li><li>
<p><code>false</code> if none of the identifiers in the publication have been
modified.</p>
</li></ul>
          

          
          <div class="method-source-code" id="modified-3F-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 438</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">modified?</span>
  <span class="ruby-identifier">retval</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">identifiers</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">retval</span> = <span class="ruby-identifier">retval</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">modified?</span>
  <span class="ruby-keyword">end</span>
  
  <span class="ruby-identifier">retval</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- modified-3F-source -->
          
        </div>

        

        
      </div><!-- modified-3F-method -->

    
      <div id="method-i-mutable-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">mutable?</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Determines if publication is in ‘editing’ status and is able to be
changed <strong>Returns</strong></p>
<ul><li>
<p><code>true</code> if the publication should be changed by some user.</p>
</li><li>
<p><code>false</code> otherwise.</p>
</li></ul>
          

          
          <div class="method-source-code" id="mutable-3F-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 451</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">mutable?</span>
  <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">!=</span> <span class="ruby-string">&quot;editing&quot;</span> <span class="ruby-comment"># &amp;&amp; self.status != &quot;new&quot;</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- mutable-3F-source -->
          
        </div>

        

        
      </div><!-- mutable-3F-method -->

    
      <div id="method-i-mutable_by-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">mutable_by?</span><span
            class="method-args">(check_user)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p><strong>Args</strong></p>
<ul><li>
<p><code>check_user</code> see if the publication is mutable by this user.</p>
</li></ul>

<p><strong>Returns</strong></p>
<ul><li>
<p><code>true</code> if the publication should be changed by some the user
specifed by check_user.</p>
</li><li>
<p><code>false</code> otherwise.</p>
</li></ul>
          

          
          <div class="method-source-code" id="mutable_by-3F-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 465</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">mutable_by?</span>(<span class="ruby-identifier">check_user</span>)
  <span class="ruby-keyword">if</span> (((<span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Board</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">check_user</span>))) <span class="ruby-operator">||</span>
      (<span class="ruby-identifier">check_user</span> <span class="ruby-operator">!=</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>)) <span class="ruby-operator">&amp;&amp;</span>
     (<span class="ruby-operator">!</span>(<span class="ruby-identifier">check_user</span>.<span class="ruby-identifier">developer</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">check_user</span>.<span class="ruby-identifier">admin</span>))
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- mutable_by-3F-source -->
          
        </div>

        

        
      </div><!-- mutable_by-3F-method -->

    
      <div id="method-i-origin" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">origin</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Finds the publication with no parent. This will be the creators copy.</p>

<p><strong>Returns</strong> <code>publication</code> that is the begining of
the publication workflow chain.</p>
          

          
          <div class="method-source-code" id="origin-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 1183</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">origin</span>
  <span class="ruby-comment"># walk the parent list until we encounter one with no parent</span>
  <span class="ruby-identifier">origin_publication</span> = <span class="ruby-keyword">self</span>
  <span class="ruby-keyword">while</span> (<span class="ruby-identifier">origin_publication</span>.<span class="ruby-identifier">parent</span> <span class="ruby-operator">!=</span> <span class="ruby-keyword">nil</span>) <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">origin_publication</span> = <span class="ruby-identifier">origin_publication</span>.<span class="ruby-identifier">parent</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">origin_publication</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- origin-source -->
          
        </div>

        

        
      </div><!-- origin-method -->

    
      <div id="method-i-populate_identifiers_from_identifiers" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">populate_identifiers_from_identifiers</span><span
            class="method-args">(identifiers, original_title = nil)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Populates the publication’s list of identifiers. Input identifiers can be
in the form of</p>

<pre>* an array of strings such as: papyri.info/ddbdp/bgu;7;1504
* a single string such as: papyri.info/ddbdp/bgu;7;1504</pre>

<p>publication title is named using first identifier</p>
          

          
          <div class="method-source-code" id="populate_identifiers_from_identifiers-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 108</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">populate_identifiers_from_identifiers</span>(<span class="ruby-identifier">identifiers</span>, <span class="ruby-identifier">original_title</span> = <span class="ruby-keyword">nil</span>)

  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">update_master_from_canonical</span>
  <span class="ruby-comment"># Coming in from an identifier, build up a publication</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">identifiers</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">String</span>
    <span class="ruby-comment"># have a string, need to build relation</span>
    <span class="ruby-identifier">identifiers</span> = <span class="ruby-constant">NumbersRDF</span><span class="ruby-operator">::</span><span class="ruby-constant">NumbersHelper</span>.<span class="ruby-identifier">identifier_to_identifiers</span>(<span class="ruby-identifier">identifiers</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment">#identifiers is now an array ofstrings like:  papyri.info/ddbdp/bgu;7;1504</span>
  <span class="ruby-identifier">identifiers</span> = <span class="ruby-constant">NumbersRDF</span><span class="ruby-operator">::</span><span class="ruby-constant">NumbersHelper</span>.<span class="ruby-identifier">identifiers_to_hash</span>(<span class="ruby-identifier">identifiers</span>)
  <span class="ruby-comment">#identifiers is now a hash with IDENTIFIER_NAMESPACE (hgv, tm, ddbdp etc)  as the keys and the string papyri.info/ddbdp/bgu;7;1504 as the value</span>


  <span class="ruby-comment">#title is first identifier in list</span>
  <span class="ruby-comment">#but added the option to set the title to whatever the caller wants</span>
  <span class="ruby-keyword">if</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">original_title</span>
    <span class="ruby-identifier">original_title</span> = <span class="ruby-identifier">identifier_to_ref</span>(<span class="ruby-identifier">identifiers</span>.<span class="ruby-identifier">values</span>.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">first</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">original_was_nil</span> = <span class="ruby-keyword">true</span>;
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">title</span> = <span class="ruby-identifier">original_title</span>

  [<span class="ruby-constant">DDBIdentifier</span>, <span class="ruby-constant">HGVMetaIdentifier</span>, <span class="ruby-constant">HGVTransIdentifier</span>, <span class="ruby-constant">BiblioIdentifier</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">identifier_class</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">identifiers</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-identifier">identifier_class</span><span class="ruby-operator">::</span><span class="ruby-constant">IDENTIFIER_NAMESPACE</span>)
      <span class="ruby-identifier">identifiers</span>[<span class="ruby-identifier">identifier_class</span><span class="ruby-operator">::</span><span class="ruby-constant">IDENTIFIER_NAMESPACE</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">identifier_string</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">temp_id</span> = <span class="ruby-identifier">identifier_class</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">identifier_string</span>)
        <span class="ruby-comment"># make sure we have a path on master before forking it for this publication</span>
        <span class="ruby-keyword">unless</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">repository</span>.<span class="ruby-identifier">get_file_from_branch</span>(<span class="ruby-identifier">temp_id</span>.<span class="ruby-identifier">to_path</span>, <span class="ruby-string">'master'</span>).<span class="ruby-identifier">blank?</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">identifiers</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">temp_id</span>
          <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">title</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">original_title</span>
            <span class="ruby-keyword">self</span>.<span class="ruby-identifier">title</span> = <span class="ruby-identifier">temp_id</span>.<span class="ruby-identifier">titleize</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment">#reset the title to what the caller wants</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">original_was_nil</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">title</span> = <span class="ruby-identifier">original_title</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-comment"># Use HGV hack for now</span>
  <span class="ruby-comment"># if identifiers.has_key?('hgv') &amp;&amp; identifiers.has_key?('trismegistos')</span>
  <span class="ruby-comment">#   identifiers['trismegistos'].each do |tm|</span>
  <span class="ruby-comment">#     tm_nr = NumbersRDF::NumbersHelper.identifier_to_components(tm).last</span>
  <span class="ruby-comment">#     self.identifiers &lt;&lt; HGVMetaIdentifier.new(</span>
  <span class="ruby-comment">#       :name =&gt; &quot;#{identifiers['hgv'].first}&quot;,</span>
  <span class="ruby-comment">#       :alternate_name =&gt; &quot;hgv#{tm_nr}&quot;)</span>
  <span class="ruby-comment">#     </span>
  <span class="ruby-comment">#     # Check if there's a trans, if so, add it</span>
  <span class="ruby-comment">#     translation = HGVTransIdentifier.new(</span>
  <span class="ruby-comment">#       :name =&gt; &quot;#{identifiers['hgv'].first}&quot;,</span>
  <span class="ruby-comment">#       :alternate_name =&gt; &quot;hgv#{tm_nr}&quot;</span>
  <span class="ruby-comment">#     )</span>
  <span class="ruby-comment">#     if !(Repository.new.get_file_from_branch(translation.to_path).nil?)</span>
  <span class="ruby-comment">#       self.identifiers &lt;&lt; translation</span>
  <span class="ruby-comment">#     end</span>
  <span class="ruby-comment">#   end</span>
  <span class="ruby-comment"># end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- populate_identifiers_from_identifiers-source -->
          
        </div>

        

        
      </div><!-- populate_identifiers_from_identifiers-method -->

    
      <div id="method-i-print" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">print</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="print-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 60</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">print</span>
  <span class="ruby-comment"># get preview of each identifier</span>
  <span class="ruby-identifier">tmp</span> = {}
  <span class="ruby-identifier">identifiers</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">identifier</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">tmp</span>[<span class="ruby-identifier">identifier</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">to_sym</span>] = <span class="ruby-identifier">identifier</span>.<span class="ruby-identifier">preview</span>({<span class="ruby-string">'meta-style'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'sammelbuch'</span>, <span class="ruby-string">'leiden-style'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'ddbdp'</span>}, <span class="ruby-node">%w{data xslt epidoc start-odf.xsl}</span>)
  }

  <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span>(<span class="ruby-string">'---------------DDB xml ---------------------'</span>)

  <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-identifier">tmp</span>[<span class="ruby-value">:DDBIdentifier</span>].<span class="ruby-identifier">to_s</span>

  <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span>(<span class="ruby-string">'------------------------------------'</span>)

  <span class="ruby-comment">#merge xml</span>
  <span class="ruby-identifier">meta</span> = <span class="ruby-constant">REXML</span><span class="ruby-operator">::</span><span class="ruby-constant">Document</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">tmp</span>[<span class="ruby-value">:HGVMetaIdentifier</span>]
  <span class="ruby-identifier">text</span> = <span class="ruby-constant">REXML</span><span class="ruby-operator">::</span><span class="ruby-constant">Document</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">tmp</span>[<span class="ruby-value">:DDBIdentifier</span>]

  <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span>(<span class="ruby-string">'---------------DDB xml document---------------------'</span>)

  <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-identifier">text</span>.<span class="ruby-identifier">elements</span>[<span class="ruby-string">&quot;//office:document-content/office:body/office:text&quot;</span>].<span class="ruby-identifier">to_s</span>
  
  <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span>(<span class="ruby-string">'------------------------------------'</span>)

  <span class="ruby-identifier">elder</span> = <span class="ruby-identifier">meta</span>.<span class="ruby-identifier">elements</span>[<span class="ruby-string">&quot;//office:document-content/office:body/office:text/text:p[@text:style-name='Sammelbuch-Kopf']&quot;</span>]
  <span class="ruby-identifier">text</span>.<span class="ruby-identifier">elements</span>[<span class="ruby-string">&quot;//office:document-content/office:body/office:text&quot;</span>].<span class="ruby-identifier">each_element</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">text_element</span><span class="ruby-operator">|</span>

  <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span>(<span class="ruby-string">'**** found['</span><span class="ruby-operator">+</span><span class="ruby-identifier">text_element</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">inspect</span><span class="ruby-operator">+</span><span class="ruby-string">']'</span>)

    <span class="ruby-identifier">meta</span>.<span class="ruby-identifier">elements</span>[<span class="ruby-string">&quot;//office:document-content/office:body/office:text&quot;</span>].<span class="ruby-identifier">insert_after</span>(<span class="ruby-identifier">elder</span>, <span class="ruby-identifier">text_element</span>)
    <span class="ruby-identifier">elder</span> = <span class="ruby-identifier">text_element</span>

  }
  
  <span class="ruby-comment"># output string</span>
  <span class="ruby-identifier">formatter</span> = <span class="ruby-constant">REXML</span><span class="ruby-operator">::</span><span class="ruby-constant">Formatters</span><span class="ruby-operator">::</span><span class="ruby-constant">Default</span>.<span class="ruby-identifier">new</span>
  <span class="ruby-comment">#formatter.compact = true</span>
  <span class="ruby-comment">#formatter.width = 512</span>
  <span class="ruby-identifier">xml</span> = <span class="ruby-string">''</span>
  <span class="ruby-identifier">formatter</span>.<span class="ruby-identifier">write</span> <span class="ruby-identifier">meta</span>, <span class="ruby-identifier">xml</span>

  <span class="ruby-identifier">xml</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- print-source -->
          
        </div>

        

        
      </div><!-- print-method -->

    
      <div id="method-i-remove_finalizer" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">remove_finalizer</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Destroys this publication’s finalizer’s copy.</p>
          

          
          <div class="method-source-code" id="remove_finalizer-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 834</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">remove_finalizer</span>
  <span class="ruby-comment"># need to find out if there is a finalizer, and take the publication from them</span>
  <span class="ruby-comment"># finalizer will point back to this board's publication</span>
  <span class="ruby-identifier">current_finalizer_publication</span> = <span class="ruby-identifier">find_finalizer_publication</span>

  <span class="ruby-comment"># TODO cascading comment deletes?</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_finalizer_publication</span>
    <span class="ruby-identifier">current_finalizer_publication</span>.<span class="ruby-identifier">destroy</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- remove_finalizer-source -->
          
        </div>

        

        
      </div><!-- remove_finalizer-method -->

    
      <div id="method-i-repository" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">repository</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="repository-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 1341</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">repository</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">repository</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- repository-source -->
          
        </div>

        

        
      </div><!-- repository-method -->

    
      <div id="method-i-send_to_finalizer" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">send_to_finalizer</span><span
            class="method-args">(finalizer = nil)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Finalizer is a user who is responsible for preparing the publication for
the final commit to canon. They will be given a copy of the publication to
edit. This function sets the finalizer up with a copy of the publicaiton.</p>

<p><strong>Args</strong></p>
<ul><li>
<p><code>finalizer</code> user who will become the finalizer. If no finalizer
given, a board member will be randomly choosen.</p>
</li></ul>
          

          
          <div class="method-source-code" id="send_to_finalizer-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 814</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">send_to_finalizer</span>(<span class="ruby-identifier">finalizer</span> = <span class="ruby-keyword">nil</span>)
    <span class="ruby-identifier">board_members</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">users</span>   
    <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">finalizer</span>
      <span class="ruby-comment">#get someone from the board    </span>
<span class="ruby-comment">#      board_members = self.owner.users    </span>
      <span class="ruby-comment"># just select a random board member to be the finalizer</span>
      <span class="ruby-identifier">finalizer</span> = <span class="ruby-identifier">board_members</span>[<span class="ruby-identifier">rand</span>(<span class="ruby-identifier">board_members</span>.<span class="ruby-identifier">length</span>)]  
    <span class="ruby-keyword">end</span>
      
    <span class="ruby-comment"># finalizing_publication = copy_to_owner(finalizer)</span>
    <span class="ruby-identifier">finalizing_publication</span> = <span class="ruby-identifier">clone_to_owner</span>(<span class="ruby-identifier">finalizer</span>)
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">flatten_commits</span>(<span class="ruby-identifier">finalizing_publication</span>, <span class="ruby-identifier">finalizer</span>, <span class="ruby-identifier">board_members</span>)
    
    <span class="ruby-comment">#should we clear the modified flag so we can tell if the finalizer has done anything</span>
    <span class="ruby-comment"># that way we will know in the future if we can change finalizersedidd</span>
    <span class="ruby-identifier">finalizing_publication</span>.<span class="ruby-identifier">change_status</span>(<span class="ruby-string">'finalizing'</span>)
    <span class="ruby-identifier">finalizing_publication</span>.<span class="ruby-identifier">save!</span>
  <span class="ruby-keyword">end</span></pre>
          </div><!-- send_to_finalizer-source -->
          
        </div>

        

        
      </div><!-- send_to_finalizer-method -->

    
      <div id="method-i-set_board_identifier_status" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">set_board_identifier_status</span><span
            class="method-args">(status_in)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Sets the board’s publication identifier status. This is used when the
finalizer’s copy needs to change the board’s copy.</p>
          

          
          <div class="method-source-code" id="set_board_identifier_status-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 525</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">set_board_identifier_status</span>(<span class="ruby-identifier">status_in</span>)
    <span class="ruby-identifier">pub</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">find_first_board_parent</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">pub</span>            
      <span class="ruby-identifier">pub</span>.<span class="ruby-identifier">identifiers</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">pub</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">identifier_classes</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">pub</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">identifier_classes</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">i</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">to_s</span>)
          <span class="ruby-identifier">i</span>.<span class="ruby-identifier">status</span> = <span class="ruby-identifier">status_in</span>
          <span class="ruby-identifier">i</span>.<span class="ruby-identifier">save</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- set_board_identifier_status-source -->
          
        </div>

        

        
      </div><!-- set_board_identifier_status-method -->

    
      <div id="method-i-set_local_identifier_status" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">set_local_identifier_status</span><span
            class="method-args">(status_in)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Sets the status for publication identifiers that this publication’s board
controls. Sets are made on the board’s copy.</p>

<p><strong>Args</strong></p>
<ul><li>
<p><code>status_in</code> the status to be set</p>
</li></ul>
          

          
          <div class="method-source-code" id="set_local_identifier_status-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 503</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">set_local_identifier_status</span>(<span class="ruby-identifier">status_in</span>)   

    <span class="ruby-identifier">board</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">find_first_board</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">board</span>
          
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">identifiers</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">board</span>.<span class="ruby-identifier">identifier_classes</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">board</span>.<span class="ruby-identifier">identifier_classes</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">i</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">to_s</span>)
          <span class="ruby-identifier">i</span>.<span class="ruby-identifier">status</span> = <span class="ruby-identifier">status_in</span>
          <span class="ruby-identifier">i</span>.<span class="ruby-identifier">save</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
      
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- set_local_identifier_status-source -->
          
        </div>

        

        
      </div><!-- set_local_identifier_status-method -->

    
      <div id="method-i-set_origin_and_local_identifier_status" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">set_origin_and_local_identifier_status</span><span
            class="method-args">(status_in)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Convenience method to combine  <a
href="Publication.html#method-i-set_origin_identifier_status">#set_origin_identifier_status</a>
&amp; <a
href="Publication.html#method-i-set_local_identifier_status">#set_local_identifier_status</a>
methods.</p>
          

          
          <div class="method-source-code" id="set_origin_and_local_identifier_status-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 519</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">set_origin_and_local_identifier_status</span>(<span class="ruby-identifier">status_in</span>)
  <span class="ruby-identifier">set_origin_identifier_status</span>(<span class="ruby-identifier">status_in</span>)          
  <span class="ruby-identifier">set_local_identifier_status</span>(<span class="ruby-identifier">status_in</span>)          
<span class="ruby-keyword">end</span></pre>
          </div><!-- set_origin_and_local_identifier_status-source -->
          
        </div>

        

        
      </div><!-- set_origin_and_local_identifier_status-method -->

    
      <div id="method-i-set_origin_identifier_status" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">set_origin_identifier_status</span><span
            class="method-args">(status_in)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Sets the origin status for publication identifiers that this
publication’s board controls. Sets are made on the origin copy.</p>

<p><strong>Args</strong></p>
<ul><li>
<p><code>status_in</code> the status to be set</p>
</li></ul>
          

          
          <div class="method-source-code" id="set_origin_identifier_status-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 483</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">set_origin_identifier_status</span>(<span class="ruby-identifier">status_in</span>)
    <span class="ruby-comment">#finalizer is a user so they dont have a board, must go up until we find a board</span>
    <span class="ruby-identifier">board</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">find_first_board</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">board</span>
            
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">identifiers</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">board</span>.<span class="ruby-identifier">identifier_classes</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">board</span>.<span class="ruby-identifier">identifier_classes</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">i</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">to_s</span>)
          <span class="ruby-identifier">i</span>.<span class="ruby-identifier">origin</span>.<span class="ruby-identifier">status</span> = <span class="ruby-identifier">status_in</span>
          <span class="ruby-identifier">i</span>.<span class="ruby-identifier">origin</span>.<span class="ruby-identifier">save</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
      
    <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- set_origin_identifier_status-source -->
          
        </div>

        

        
      </div><!-- set_origin_identifier_status-method -->

    
      <div id="method-i-submission_reason" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">submission_reason</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p><strong>Returns</strong> comment object with the publication’s submit
comment.</p>
          

          
          <div class="method-source-code" id="submission_reason-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 1176</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">submission_reason</span>
  <span class="ruby-identifier">reason</span> = <span class="ruby-constant">Comment</span>.<span class="ruby-identifier">find_by_publication_id</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">origin</span>.<span class="ruby-identifier">id</span>, <span class="ruby-value">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;reason = 'submit'&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- submission_reason-source -->
          
        </div>

        

        
      </div><!-- submission_reason-method -->

    
      <div id="method-i-submit" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">submit</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Simply pointer to <a
href="Publication.html#method-i-submit_to_next_board">#submit_to_next_board</a>
method.</p>
          

          
          <div class="method-source-code" id="submit-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 402</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">submit</span>
  <span class="ruby-identifier">submit_to_next_board</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- submit-source -->
          
        </div>

        

        
      </div><!-- submit-method -->

    
      <div id="method-i-submit_to_next_board" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">submit_to_next_board</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Examines publication to see which board the publication should be submitted
to next. Boards are sorted by rank. Each board, in order of rank, will
check to see if they control any of the publication’s modified and
editing identifiers.  If so, then the publication is submitted to that
board.</p>

<p>When there are no more identifiers to be submitted, then the publication is
marked as committed.</p>
          

          
          <div class="method-source-code" id="submit_to_next_board-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 217</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">submit_to_next_board</span>

  <span class="ruby-comment">#note: all @recent_submit_sha conde here added because it was here before, not sure if this is still needed</span>
  <span class="ruby-ivar">@recent_submit_sha</span> = <span class="ruby-string">''</span>

  <span class="ruby-comment">#determine which ids are ready to be submitted (modified, editing...)</span>
  <span class="ruby-identifier">submittable_identifiers</span> = <span class="ruby-identifier">identifiers</span>.<span class="ruby-identifier">select</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">id</span><span class="ruby-operator">|</span> <span class="ruby-identifier">id</span>.<span class="ruby-identifier">modified?</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">id</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">==</span> <span class="ruby-string">'editing'</span>)}
  
  <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-string">&quot;---Submittable identifiers are: &quot;</span> 
  <span class="ruby-identifier">submittable_identifiers</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">log_si</span><span class="ruby-operator">|</span>
    <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-string">&quot;     &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">log_si</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot;   &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">log_si</span>.<span class="ruby-identifier">title</span>
  <span class="ruby-keyword">end</span>
  
  
  <span class="ruby-comment">#check if we are part of a community</span>
 
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">is_community_publication?</span>
    <span class="ruby-identifier">boards</span> = <span class="ruby-constant">Board</span>.<span class="ruby-identifier">ranked_by_community_id</span>( <span class="ruby-keyword">self</span>.<span class="ruby-identifier">community</span>.<span class="ruby-identifier">id</span> )
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">boards</span> = <span class="ruby-constant">Board</span>.<span class="ruby-identifier">ranked</span>  
  <span class="ruby-keyword">end</span>
  
  <span class="ruby-comment">#check each board in order by priority rank</span>
  <span class="ruby-identifier">boards</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">board</span><span class="ruby-operator">|</span>

    <span class="ruby-comment">#if board.community == publication.community</span>
      <span class="ruby-identifier">boards_identifiers</span> = <span class="ruby-identifier">submittable_identifiers</span>.<span class="ruby-identifier">select</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">id</span><span class="ruby-operator">|</span> <span class="ruby-identifier">board</span>.<span class="ruby-identifier">controls_identifier?</span>(<span class="ruby-identifier">id</span>) }
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">boards_identifiers</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
        <span class="ruby-comment">#submit to that board</span>

  <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-string">&quot;---Submittable Board identifiers are: &quot;</span> 
  <span class="ruby-identifier">boards_identifiers</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">log_sbi</span><span class="ruby-operator">|</span>
    <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-string">&quot;     &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">log_sbi</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot;   &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">log_sbi</span>.<span class="ruby-identifier">title</span>
  <span class="ruby-keyword">end</span>

        <span class="ruby-comment">#find the comment text made on submission</span>
        <span class="ruby-identifier">comment_text</span> = <span class="ruby-string">''</span> <span class="ruby-comment">#if no comment found, default to nothing. This should never happen.</span>
        <span class="ruby-keyword">begin</span>
          <span class="ruby-identifier">submit_comment</span> = <span class="ruby-constant">Comment</span>.<span class="ruby-identifier">find</span>(<span class="ruby-value">:last</span>, <span class="ruby-value">:conditions</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-value">:publication_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">id</span>, <span class="ruby-value">:reason</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;submit&quot;</span> } )
          <span class="ruby-keyword">if</span> <span class="ruby-identifier">submit_comment</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">submit_comment</span>.<span class="ruby-identifier">comment</span>
            <span class="ruby-identifier">comment_text</span> = <span class="ruby-identifier">submit_comment</span>.<span class="ruby-identifier">comment</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">rescue</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">RecordNotFound</span>
          <span class="ruby-comment">#comment_text already = ''</span>
          <span class="ruby-comment">#TODO raise warning? add error logging</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-comment">#update the change_desc of each submitted identifier</span>
        <span class="ruby-identifier">boards_identifiers</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">submitting_identifier</span><span class="ruby-operator">|</span>
          <span class="ruby-identifier">submitting_identifier</span>.<span class="ruby-identifier">set_xml_content</span>(<span class="ruby-identifier">submitting_identifier</span>.<span class="ruby-identifier">add_change_desc</span>(<span class="ruby-identifier">comment_text</span>), <span class="ruby-value">:comment</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">comment_text</span>)
          <span class="ruby-identifier">submitting_identifier</span>.<span class="ruby-identifier">status</span> = <span class="ruby-string">&quot;submitted&quot;</span>
          <span class="ruby-identifier">submitting_identifier</span>.<span class="ruby-identifier">save!</span>

          <span class="ruby-comment">#make the most recent sha for the identifier available...is this the one we want?</span>
          <span class="ruby-ivar">@recent_submit_sha</span> = <span class="ruby-identifier">submitting_identifier</span>.<span class="ruby-identifier">get_recent_commit_sha</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-comment">#copy the repo, models, etc... to the board</span>
        <span class="ruby-identifier">boards_copy</span> = <span class="ruby-identifier">copy_to_owner</span>(<span class="ruby-identifier">board</span>)
        <span class="ruby-identifier">boards_copy</span>.<span class="ruby-identifier">status</span> = <span class="ruby-string">&quot;voting&quot;</span>
        <span class="ruby-identifier">boards_copy</span>.<span class="ruby-identifier">save!</span>



        <span class="ruby-comment">#trigger emails</span>
        <span class="ruby-identifier">board</span>.<span class="ruby-identifier">send_status_emails</span>(<span class="ruby-string">&quot;submitted&quot;</span>, <span class="ruby-keyword">self</span>)

        <span class="ruby-comment">#update status on user copy</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">change_status</span>(<span class="ruby-string">&quot;submitted&quot;</span>)
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">save!</span>

        <span class="ruby-comment">#problem here in that comment will be added to the returned id, but there may be many ids.....</span>
        <span class="ruby-comment">#todo move where the comment is being placed, need to have discussion about where comments go 2-22-2010</span>
        <span class="ruby-keyword">return</span> <span class="ruby-string">''</span>, <span class="ruby-identifier">boards_identifiers</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">id</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-comment">#end</span>
  <span class="ruby-keyword">end</span>


  <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-string">&quot; no more parts to submit &quot;</span>
  <span class="ruby-comment">#if we get to this point, there are no more boards to submit to, thus we are done</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">is_community_publication?</span>
    <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">community</span>.<span class="ruby-identifier">end_user</span>.<span class="ruby-identifier">nil?</span>
      <span class="ruby-comment">#no end user has been set, so warn them and then what?</span>
      <span class="ruby-comment">#user can't submit to community if no end user, so this should not happen</span>
      
    <span class="ruby-keyword">else</span>
      
      
      <span class="ruby-comment">#copy to  space</span>
      <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-string">&quot;----end user to get it&quot;</span> 
      <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">community</span>.<span class="ruby-identifier">end_user</span>.<span class="ruby-identifier">name</span>
      
      <span class="ruby-comment">#community_copy = copy_to_owner( self.community.end_user)</span>
      <span class="ruby-identifier">community_copy</span> = <span class="ruby-identifier">copy_to_end_user</span>()
      <span class="ruby-identifier">community_copy</span>.<span class="ruby-identifier">status</span> = <span class="ruby-string">&quot;editing&quot;</span>
      <span class="ruby-identifier">community_copy</span>.<span class="ruby-identifier">identifiers</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">id</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">id</span>.<span class="ruby-identifier">status</span> = <span class="ruby-string">&quot;editing&quot;</span>
        <span class="ruby-identifier">id</span>.<span class="ruby-identifier">save</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-comment">#TODO may need to do more status setting ? ie will the modified identifiers and status be correctly set to allow resubmit by end user?</span>
      
      <span class="ruby-comment">#disconnect the parent/origin connections</span>
      <span class="ruby-comment">#community_copy.parent_id = nil</span>
      <span class="ruby-identifier">community_copy</span>.<span class="ruby-identifier">parent</span> = <span class="ruby-keyword">nil</span>
      
      <span class="ruby-comment">#reset the community id to be sosol</span>
      <span class="ruby-comment">#leave as is   community_copy.community_id = nil</span>
      
      <span class="ruby-comment">#remove the original creator id (that info is now in the git history )</span>
      <span class="ruby-identifier">community_copy</span>.<span class="ruby-identifier">creator_id</span> = <span class="ruby-identifier">community_copy</span>.<span class="ruby-identifier">owner_id</span>
      
      <span class="ruby-identifier">community_copy</span>.<span class="ruby-identifier">save!</span>
      
      <span class="ruby-comment">#mark as committed</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">origin</span>.<span class="ruby-identifier">change_status</span>(<span class="ruby-string">&quot;committed&quot;</span>)
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">save</span>
    <span class="ruby-keyword">end</span>
    
  <span class="ruby-keyword">else</span>
    <span class="ruby-comment">#mark as committed</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">origin</span>.<span class="ruby-identifier">change_status</span>(<span class="ruby-string">&quot;committed&quot;</span>)
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">save</span>    
  <span class="ruby-keyword">end</span>
  
  
  <span class="ruby-comment">#TODO need to return something here to prevent flash error from showing true?</span>
  <span class="ruby-keyword">return</span> <span class="ruby-string">&quot;&quot;</span>, <span class="ruby-keyword">nil</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- submit_to_next_board-source -->
          
        </div>

        

        
      </div><!-- submit_to_next_board-method -->

    
      <div id="method-i-tally_votes" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">tally_votes</span><span
            class="method-args">(user_votes = nil)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>This is where the main action takes place for deciding how votes are
organized and what happens for vote results.</p>

<p><strong>Args</strong></p>
<ul><li>
<p><code>user_votes</code> the votes to be tallied. By default, the
publicaiton’s own votes are used.</p>
</li></ul>

<p><strong>Returns</strong></p>
<ul><li>
<p><code>decree_action</code> determined by the vote tally or <code>nil</code>
if no decree is triggered by the tally.</p>
</li></ul>

<p><strong>Effects</strong></p>
<ul><li>
<p>Calls methods and sets status based on vote tally. See implementation for
details.</p>
</li></ul>
          

          
          <div class="method-source-code" id="tally_votes-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 606</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">tally_votes</span>(<span class="ruby-identifier">user_votes</span> = <span class="ruby-keyword">nil</span>)
  <span class="ruby-identifier">user_votes</span> <span class="ruby-operator">||=</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">votes</span> <span class="ruby-comment">#use the publication's votes</span>
  <span class="ruby-comment">#here is where the action is for deciding how votes are organized and what happens for vote results</span>
  <span class="ruby-comment">#as of 3-11-2011 the votes are set on the identifier where the user votes &amp; on the publication</span>
  <span class="ruby-comment">#once a user has voted on any identifier of a publication, then they can no longer vote on the publication</span>
  <span class="ruby-comment">#vote action is determined by votes on the publication</span>
  <span class="ruby-comment">#any modified identifiers that the board controlls will have the change desc added.</span>
  <span class="ruby-comment">#Future changes may be made here if the voting logic is to be separated per identifier</span>
  
  <span class="ruby-comment">#check that we are still taking votes</span>
  <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">!=</span> <span class="ruby-string">&quot;voting&quot;</span>
    <span class="ruby-keyword">return</span> <span class="ruby-string">&quot;&quot;</span> <span class="ruby-comment">#return nothing and do nothing since the voting is now over</span>
  <span class="ruby-keyword">end</span>
  
  <span class="ruby-comment">#need to tally votes and see if any action will take place</span>
  <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner_type</span> <span class="ruby-operator">!=</span> <span class="ruby-string">&quot;Board&quot;</span> <span class="ruby-comment"># || !self.owner #make sure board still exist...add error message?</span>
    <span class="ruby-keyword">return</span> <span class="ruby-string">&quot;&quot;</span> <span class="ruby-comment">#another check to make sure only the board is voting on its copy</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">decree_action</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">tally_votes</span>(<span class="ruby-identifier">user_votes</span>) <span class="ruby-comment">#since board has decrees let them figure out the vote results</span>
  <span class="ruby-keyword">end</span>
 

  <span class="ruby-comment"># create an event if anything happened</span>
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">decree_action</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">decree_action</span> <span class="ruby-operator">!=</span> <span class="ruby-string">''</span>
    <span class="ruby-identifier">e</span> = <span class="ruby-constant">Event</span>.<span class="ruby-identifier">new</span>
    <span class="ruby-identifier">e</span>.<span class="ruby-identifier">owner</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>
    <span class="ruby-identifier">e</span>.<span class="ruby-identifier">target</span> = <span class="ruby-keyword">self</span>
    <span class="ruby-identifier">e</span>.<span class="ruby-identifier">category</span> = <span class="ruby-node">&quot;marked as \&quot;#{decree_action}\&quot;&quot;</span>
    <span class="ruby-identifier">e</span>.<span class="ruby-identifier">save!</span>
  <span class="ruby-keyword">end</span>

<span class="ruby-comment">#----approve-----</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">decree_action</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;approve&quot;</span>
    
    <span class="ruby-comment">#set status</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">change_status</span>(<span class="ruby-string">&quot;approved&quot;</span>)
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">set_origin_and_local_identifier_status</span>(<span class="ruby-string">&quot;approved&quot;</span>)
    
    <span class="ruby-comment">#send emails</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">send_status_emails</span>(<span class="ruby-string">&quot;approved&quot;</span>, <span class="ruby-keyword">self</span>)
   
    <span class="ruby-comment">#set up for finalizing</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">send_to_finalizer</span>
    
<span class="ruby-comment">#----reject-----    </span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">decree_action</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;reject&quot;</span>   
   
    <span class="ruby-comment">#set status</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">origin</span>.<span class="ruby-identifier">change_status</span>(<span class="ruby-string">&quot;editing&quot;</span>)
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">set_origin_and_local_identifier_status</span>(<span class="ruby-string">&quot;editing&quot;</span>)
    
    <span class="ruby-comment">#send emails</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">send_status_emails</span>(<span class="ruby-string">&quot;rejected&quot;</span>, <span class="ruby-keyword">self</span>)
    
    <span class="ruby-comment">#do we want to copy ours back to the user? </span>
    <span class="ruby-comment">#TODO add copy to user</span>
    <span class="ruby-comment">#NOTE since they decided not to let editors edit we don't need to copy back to user 1-28-2010</span>
    
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">origin</span>.<span class="ruby-identifier">save!</span>
    
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">destroy</span>
    
<span class="ruby-comment">#----graffiti-----      </span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">decree_action</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;graffiti&quot;</span>               
    <span class="ruby-comment"># @publication.send_status_emails(decree_action)</span>
    <span class="ruby-comment">#do destroy after email since the email may need info in the artice</span>
    <span class="ruby-comment">#@publication.get_category_obj().graffiti</span>
    
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">owner</span>.<span class="ruby-identifier">send_status_emails</span>(<span class="ruby-string">&quot;graffiti&quot;</span>, <span class="ruby-keyword">self</span>)
    <span class="ruby-comment">#todo do we let one board destroy the entire document?</span>
    <span class="ruby-comment">#will this destroy all board copies....</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">origin</span>.<span class="ruby-identifier">destroy</span> <span class="ruby-comment">#need to destroy related? </span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">destroy</span>
   <span class="ruby-comment"># redirect_to ( dashboard_url )</span>
    <span class="ruby-comment">#TODO we need to walk the tree and delete everything everywhere??</span>
    <span class="ruby-comment">#or</span>
    <span class="ruby-comment">#self.submit_to_next_board</span>
    
<span class="ruby-comment">#----uknown on none-----      </span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-comment">#unknown action or no action</span>
    <span class="ruby-comment">#TODO allow board to return any action, and then call that action on the identifier, board or wherever it makes sense to allow the user to add to the class</span>
    <span class="ruby-comment">#if publication has comunity name, then it may make sense for that name to be linked to a mixin or such that contains custom methods</span>
    <span class="ruby-comment">#parse action name</span>
  <span class="ruby-keyword">end</span>
  
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">decree_action</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- tally_votes-source -->
          
        </div>

        

        
      </div><!-- tally_votes-method -->

    
      <div id="method-i-user_has_voted-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">user_has_voted?</span><span
            class="method-args">(user_id)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Determines if the user has voted on this publication.</p>

<p><strong>Args</strong></p>
<ul><li>
<p><code>user_id</code> the id for the user whose voting record we wish to
test</p>
</li></ul>

<p><strong>Returns</strong></p>
<ul><li>
<p><code>true</code> if the user for the given user_id has voted on this
publication</p>
</li><li>
<p><code>false</code> if the user for the given user_id has not voted on this
publication</p>
</li></ul>
          

          
          <div class="method-source-code" id="user_has_voted-3F-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 586</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">user_has_voted?</span>(<span class="ruby-identifier">user_id</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">votes</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">votes</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">vote</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">vote</span>.<span class="ruby-identifier">user_id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">user_id</span>
        <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-comment">#user has a vote on record for this publication</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-comment">#no vote found</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- user_has_voted-3F-source -->
          
        </div>

        

        
      </div><!-- user_has_voted-3F-method -->

    
      <div id="method-i-withdraw" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">withdraw</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Destroys all board copies of a publication and resets the origin
publication’s status back to editing. This method has two main functions.
One is to allow the user to “unsubmit” their submission. The other is
to “reset” a publication that is in a confused state.</p>
          

          
          <div class="method-source-code" id="withdraw-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 1204</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">withdraw</span>
  <span class="ruby-identifier">original_origin</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">origin</span>
  <span class="ruby-comment">#if(original_origin != self) #commented out so user can withdraw there own pub, note this should not be called without checking that the pub is withdrawable</span>
    <span class="ruby-identifier">original_origin</span>.<span class="ruby-identifier">all_children</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">child_publication</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">child_publication</span>.<span class="ruby-identifier">destroy</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">original_origin</span>.<span class="ruby-identifier">change_status</span>(<span class="ruby-string">'editing'</span>)
    <span class="ruby-identifier">original_origin</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">c</span>.<span class="ruby-identifier">destroy</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">original_origin</span>.<span class="ruby-identifier">identifiers</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">i</span>.<span class="ruby-identifier">status</span> = <span class="ruby-string">'editing'</span>
      <span class="ruby-identifier">i</span>.<span class="ruby-identifier">save!</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-comment">#end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- withdraw-source -->
          
        </div>

        

        
      </div><!-- withdraw-method -->

    
    </section><!-- public-instance-method-details -->
  
     <section id="protected-instance-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Protected Instance Methods</h3>

    
      <div id="method-i-identifier_to_ref" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">identifier_to_ref</span><span
            class="method-args">(str)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Returns identifier string in form acceptable to  “.git/refs/”</p>
          

          
          <div class="method-source-code" id="identifier_to_ref-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 1520</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">identifier_to_ref</span>(<span class="ruby-identifier">str</span>)
  <span class="ruby-identifier">str</span>.<span class="ruby-identifier">tr</span>(<span class="ruby-string">':;'</span>,<span class="ruby-string">'_'</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- identifier_to_ref-source -->
          
        </div>

        

        
      </div><!-- identifier_to_ref-method -->

    
      <div id="method-i-title_to_ref" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">title_to_ref</span><span
            class="method-args">(str)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Returns title string in form acceptable to  “.git/refs/”</p>
          

          
          <div class="method-source-code" id="title_to_ref-source">
            <pre><span class="ruby-comment"># File app/models/publication.rb, line 1515</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">title_to_ref</span>(<span class="ruby-identifier">str</span>)
  <span class="ruby-identifier">str</span>.<span class="ruby-identifier">tr</span>(<span class="ruby-string">' '</span>,<span class="ruby-string">'_'</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- title_to_ref-source -->
          
        </div>

        

        
      </div><!-- title_to_ref-method -->

    
    </section><!-- protected-instance-method-details -->
  
  </section><!-- 5Buntitled-5D -->

</div><!-- documentation -->


<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 3.11.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>

